---
title: "Triple Negative Breast Cancer Data Analysis"
author: "Anni Liu"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
knit: knitautomator::knit_filename
output:
  word_document:
    fig_caption: no
    fig_height: 6
    fig_width: 6
    highlight: null
    toc: yes
    reference_docx: manuscript_style_V0.docx
params:
  date: !r format(Sys.Date(), "%Y%b%d")
  plot.fig: TRUE
  results.folder: FALSE
editor_options: 
  chunk_output_type: console
---

```{r shorcut, include=FALSE}
#################################################################
##                  RStudio keyboard shortcut                  ##
#################################################################
# Cursor at the beginning of a command line: Ctrl + A
# Cursor at the end of a command line: Ctrl + E
# Clear all the code from your console: Ctrl + L
# Create an assignment operator <-: Alt + - (Windows) or Option + - (Mac).
# Create a pipe operator %>%: Ctrl + Shift + M (Windows) or Cmd + Shift + M (Mac)
# Knit a document (knitr): Ctrl + Shift + K (Windows) or Cmd + Shift + K (Mac)
# Comment or uncomment current selection: Ctrl + Shift + C (Windows) or Cmd + Shift + C (Mac)
```


```{r attach_libraries, include=FALSE}
##################################################################
##                        Attach libraries                      ##
##################################################################
easypackages::libraries("BTKR", "multcomp", "readxl", "tidyverse", 
                        "bannerCommenter", "parallel", 
                        "tidycmprsk", "ggsurvfit")
```


```{r check_data, include=FALSE}
##################################################################
##                    Load data for checking                    ##
##################################################################
dat0 <- dget("../data/derived/2022Dec21_dat0.Rdata")
dat1 <- dget("../data/derived/2022Dec21_dat1.Rdata")
dat2 <- dget("../data/derived/2022Dec21_dat2.Rdata")
dat3 <- dget("../data/derived/2022Dec21_dat3.Rdata")
dat.work <- dget("../data/derived/2022Dec21_dat_TNBC.Rdata")
```


```{r analysis_plan_previous, include=FALSE}
#################################################################
##                    Previous analysis plan                   ##
#################################################################
## Variables to add:
## T2LR: time from Date.of.Diagnosis to date of local recurrence
## T2DR: time from Date.of.Diagnosis to date of distant recurrence
## T2NP: time from Date.of.Diagnosis to date of new primary
## T2Death: time from Date.of.Diagnosis to date of death
## T2LFU: time from Date.of.Diagnosis to date of last follow up
## LRFS.event: 1 if Local.Recurrence is Yes, 0 if No
## LRFS.time (local recurrence free survival time): T2LocRecur if had local recurrence, 
##    minimum of T2Death and T2LFU if no local recurrence
## DRFS.event: 1 if Distant.Recurrence is Yes, 0 if No
## DRFS.time (Distant recurrence free survival time): T2DisRecur if had distant recurrence, 
##    minimum of T2Death and T2LFU if no distant recurrence
## NPFS.event: 1 if New.Breast.Primary is Yes, 0 if No
## NPFS.time (New primary free survival time): T2NewPrim if had new Primary, 
##    minimum of T2Death and T2LFU if no new primary
## LR5y (5-year local recurrence):  Assign all to 0 first, 
##       change to 1 if had local recurrence and local recurrence occurred within 5 years of disease diagnosis, 
##       change to NA if no recurrence and time to last follow up since diagnosis less than 5 years  
## DR5y (5-year distant recurrence): defined in similar fashion as above
## NP5y (5-year new primary): defined in similar fashion as above


## Use the cumulative incidence function to estimate the incidence rate of local recurrence which treats death as the competing risk
### Add the following variables (lines starting from XXX):

### Death: "Yes" if Date.Death has the value
###        "No" if Date.Death has NA

### LRDeath: NA if subjects miss information on the outcome *
###          "LocRecur" if Local.Recurrence is Yes and Death is Yes or No
###          "Dead" if Death is Yes and Local.Recurrence is No
###          "Censored" if Local.Recurrence and Death are both No
### table(paste(dat3$Local.Recurrence, 
### ifelse(is.na(dat3$T2LR), "noT2LR", "T2LR"), 
### ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
### ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
### sep = ":"))
### * NA:noT2LR:noT2D:noT2LFU 6
###   NA:noT2LR:noT2D:T2LFU 75
###   NA:noT2LR:T2D:T2LFU 5
###   No:noT2LR:noT2D:noT2LFU 12
###   Yes:noT2LR:noT2D:T2LFU 2
###   100 patients miss information on the outcome  

### DRDeath: NA if subjects miss information on the outcome * 
###          "DisRecur" if Distant.Recurrence is Yes and Death is Yes or No
###          "Dead" if Death is Yes and Distant.Recurrence is No
###          "Censored" if Distant.Recurrence and Death are both No
### * NA:noT2DR:noT2D:noT2LFU 6
###   NA:noT2DR:noT2D:T2LFU 69
###   NA:noT2DR:T2D:T2LFU 5  
###   No:noT2DR:noT2D:noT2LFU 11
###   Yes:noT2DR:noT2D:noT2LFU 1
###   Yes:noT2DR:noT2D:T2LFU 12
###   Yes:noT2DR:T2D:T2LFU 1
###   105 patients miss information on the outcome

### NPDeath: NA if subjects miss information on the outcome * 
###          "NBP" if New.Breast.Primary is Yes and Death is Yes or No
###          "Dead" if Death is Yes and New.Breast.Primary is No
###          "Censored" if New.Breast.Primary and Death are both No
### * NA:noT2NP:noT2D:noT2LFU 6
###   NA:noT2NP:noT2D:T2LFU 82
###   NA:noT2NP:T2D:T2LFU 6    
###   No:noT2NP:noT2D:noT2LFU 12
###   106 patients miss information on the outcome

### T2LRDeath: NA if LRDeath is NA
###            `T2LR` if LRDeath is LocRecur
###            `T2Death` if LRDeath is Dead
###            `T2LFU` if LRDeath is Censored

### T2DRDeath: NA if DRDeath is NA
###            `T2DR` if DRDeath is DisRecur
###            `T2Death` if DRDeath is Dead
###            `T2LFU` if DRDeath is Censored

### T2NPDeath: NA if NPDeath is NA
###            `T2NP` if NPDeath is NBP
###            `T2Death` if NPDeath is Dead
###            `T2LFU` if NPDeath is Censored

## ALiu: Create event and time variables where
### 1) LR/NP with positive ER, LR/NP with negative ER, and dead are treated as competing risks; these variables are LRDeath.ER/NPDeath.ER/T2LRDeath.ER/T2NPDeath.ER
### 2) LR/NP with positive PR, LR/NP with negative PR, and dead are treated as competing risks; these variables are LRDeath.PR/NPDeath.PR/T2LRDeath.PR/T2NPDeath.PR
### 3) LR/NP with positive HER2, LR/NP with negative HER2, and dead are treated as competing risks; these variables are LRDeath.HER2/NPDeath.HER2/T2LRDeath.HER2/T2NPDeath.HER2

### LRDeath.ER: NA if subjects miss information on the outcome*
###             "LRYesERPos" if Local.Recurrence is Yes and ER.LR is Positive and Death is Yes or No
###             "LRYesERNeg" if Local.Recurrence is Yes and ER.LR is Negative and Death is Yes or No
###             "Dead" if Death is Yes and Local.Recurrence is No
###             "Censored" if Local.Recurrence and Death are both No
with(dat3, table(paste(Local.Recurrence, ER.LR, Death, # Load dat3 (refer back to the line 61)
                       ifelse(is.na(T2LR), "noT2LR", "T2LR"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# NA:Negative:No:noT2LR:noT2D:noT2LFU   NA:Negative:No:noT2LR:noT2D:T2LFU 
#                                   6*                                  75* 
#    NA:Negative:Yes:noT2LR:T2D:T2LFU         No:NA:No:noT2LR:noT2D:T2LFU 
#                                   5*                                  12* 
# No:Negative:No:noT2LR:noT2D:noT2LFU   No:Negative:No:noT2LR:noT2D:T2LFU 
#                                  12*                                 407 
#    No:Negative:Yes:noT2LR:T2D:T2LFU        Yes:NA:No:noT2LR:noT2D:T2LFU 
#                                  15                                   1* 
#           Yes:NA:Yes:T2LR:T2D:T2LFU    Yes:Negative:No:T2LR:noT2D:T2LFU 
#                                   1*                                  54 
#     Yes:Negative:Yes:T2LR:T2D:T2LFU  Yes:Positive:No:noT2LR:noT2D:T2LFU 
#                                   7                                   1* 
#    Yes:Positive:No:T2LR:noT2D:T2LFU     Yes:Positive:Yes:T2LR:T2D:T2LFU 
#                                   7                                   1 
# 113 (6+75+5+12+12+1+1+1) patients miss outcome information*


### LRDeath.PR: NA if subjects miss information on the outcome*
###             "LRYesPRPos" if Local.Recurrence is Yes and PR.LR is Positive and Death is Yes or No
###             "LRYesPRNeg" if Local.Recurrence is Yes and PR.LR is Negative and Death is Yes or No
###             "Dead" if Death is Yes and Local.Recurrence is No
###             "Censored" if Local.Recurrence and Death are both No
with(dat3, table(paste(Local.Recurrence, PR.LR, Death,
                       ifelse(is.na(T2LR), "noT2LR", "T2LR"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# NA:Negative:No:noT2LR:noT2D:noT2LFU   NA:Negative:No:noT2LR:noT2D:T2LFU 
#                                   6*                                  75* 
#    NA:Negative:Yes:noT2LR:T2D:T2LFU         No:NA:No:noT2LR:noT2D:T2LFU 
#                                   5*                                  12* 
# No:Negative:No:noT2LR:noT2D:noT2LFU   No:Negative:No:noT2LR:noT2D:T2LFU 
#                                  12*                                 407 
#    No:Negative:Yes:noT2LR:T2D:T2LFU        Yes:NA:No:noT2LR:noT2D:T2LFU 
#                                  15                                   1* 
#           Yes:NA:Yes:T2LR:T2D:T2LFU  Yes:Negative:No:noT2LR:noT2D:T2LFU 
#                                   1*                                   1* 
#    Yes:Negative:No:T2LR:noT2D:T2LFU     Yes:Negative:Yes:T2LR:T2D:T2LFU 
#                                  56                                   8 
#    Yes:Positive:No:T2LR:noT2D:T2LFU 
#                                   5 
# 113 (6+75+5+12+12+1+1+1) patients miss outcome information*


### LRDeath.HER2: NA if subjects miss information on the outcome*
###               "LRYesHER2Pos" if Local.Recurrence is Yes and HER2.LR is Positive and Death is Yes or No
###               "LRYesHER2Neg" if Local.Recurrence is Yes and HER2.LR is Negative and Death is Yes or No
###               "Dead" if Death is Yes and Local.Recurrence is No
###               "Censored" if Local.Recurrence and Death are both No
with(dat3, table(paste(Local.Recurrence, HER2.LR, Death,
                       ifelse(is.na(T2LR), "noT2LR", "T2LR"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# NA:Negative:No:noT2LR:noT2D:noT2LFU   NA:Negative:No:noT2LR:noT2D:T2LFU 
#                                   6*                                  75* 
#    NA:Negative:Yes:noT2LR:T2D:T2LFU         No:NA:No:noT2LR:noT2D:T2LFU 
#                                   5*                                  12* 
# No:Negative:No:noT2LR:noT2D:noT2LFU   No:Negative:No:noT2LR:noT2D:T2LFU 
#                                  12*                                 407 
#    No:Negative:Yes:noT2LR:T2D:T2LFU        Yes:NA:No:noT2LR:noT2D:T2LFU 
#                                  15                                   1* 
#          Yes:NA:No:T2LR:noT2D:T2LFU           Yes:NA:Yes:T2LR:T2D:T2LFU 
#                                   4*                                   2* 
#  Yes:Negative:No:noT2LR:noT2D:T2LFU    Yes:Negative:No:T2LR:noT2D:T2LFU 
#                                   1*                                  56 
#     Yes:Negative:Yes:T2LR:T2D:T2LFU    Yes:Positive:No:T2LR:noT2D:T2LFU 
#                                   7                                   1 
# 118 (6+75+5+12+12+1+4+2+1) patients miss outcome information*


### NPDeath.ER: NA if subjects miss information on the outcome*
###             "NPYesERPos" if New.Breast.Primary is Yes and ER.NP is Positive and Death is Yes or No
###             "NPYesERNeg" if New.Breast.Primary is Yes and ER.NP is Negative and Death is Yes or No
###             "Dead" if Death is Yes and New.Breast.Primary is No
###             "Censored" if New.Breast.Primary and Death are both No
with(dat3, table(paste(New.Breast.Primary, ER.NP, Death, 
                       ifelse(is.na(T2NP), "noT2NP", "T2NP"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
#       NA:NA:No:noT2NP:noT2D:T2LFU NA:Negative:No:noT2NP:noT2D:noT2LFU 
#                                 4*                                   6* 
# NA:Negative:No:noT2NP:noT2D:T2LFU    NA:Negative:Yes:noT2NP:T2D:T2LFU 
#                                78*                                   6* 
#       No:NA:No:noT2NP:noT2D:T2LFU           No:NA:No:T2NP:noT2D:T2LFU 
#                                54*                                   1* 
#        No:NA:Yes:noT2NP:T2D:T2LFU No:Negative:No:noT2NP:noT2D:noT2LFU 
#                                 7*                                  12* 
# No:Negative:No:noT2NP:noT2D:T2LFU    No:Negative:Yes:noT2NP:T2D:T2LFU 
#                               404                                  14 
#        Yes:NA:No:T2NP:noT2D:T2LFU    Yes:Negative:No:T2NP:noT2D:T2LFU 
#                                 1*                                   4 
#   Yes:Negative:Yes:T2NP:T2D:T2LFU    Yes:Positive:No:T2NP:noT2D:T2LFU 
#                                 2                                  11 
# 169 (4+6+78+6+54+1+7+12+1) patients miss outcome information*


### NPDeath.PR: NA if subjects miss information on the outcome*
###             "NPYesPRPos" if New.Breast.Primary is Yes and PR.NP is Positive and Death is Yes or No
###             "NPYesPRNeg" if New.Breast.Primary is Yes and PR.NP is Negative and Death is Yes or No
###             "Dead" if Death is Yes and New.Breast.Primary is No
###             "Censored" if New.Breast.Primary and Death are both No
with(dat3, table(paste(New.Breast.Primary, PR.NP, Death,
                       ifelse(is.na(T2NP), "noT2NP", "T2NP"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
#       NA:NA:No:noT2NP:noT2D:T2LFU NA:Negative:No:noT2NP:noT2D:noT2LFU 
#                                 4*                                   6* 
# NA:Negative:No:noT2NP:noT2D:T2LFU    NA:Negative:Yes:noT2NP:T2D:T2LFU 
#                                78*                                   6* 
#       No:NA:No:noT2NP:noT2D:T2LFU           No:NA:No:T2NP:noT2D:T2LFU 
#                                54*                                   1* 
#        No:NA:Yes:noT2NP:T2D:T2LFU No:Negative:No:noT2NP:noT2D:noT2LFU 
#                                 7*                                  12* 
# No:Negative:No:noT2NP:noT2D:T2LFU    No:Negative:Yes:noT2NP:T2D:T2LFU 
#                               404                                  14 
#        Yes:NA:No:T2NP:noT2D:T2LFU    Yes:Negative:No:T2NP:noT2D:T2LFU 
#                                 1*                                   7 
#   Yes:Negative:Yes:T2NP:T2D:T2LFU    Yes:Positive:No:T2NP:noT2D:T2LFU 
#                                 2                                   8 
# 169 (4+6+78+6+54+1+7+12+1) patients miss outcome information*


### NPDeath.HER2: NA if subjects miss information on the outcome*
###               "NPYesHER2Pos" if New.Breast.Primary is Yes and HER2.NP is Positive and Death is Yes or No
###               "NPYesHER2Neg" if New.Breast.Primary is Yes and HER2.NP is Negative and Death is Yes or No
###               "Dead" if Death is Yes and New.Breast.Primary is No
###               "Censored" if New.Breast.Primary and Death are both No
with(dat3, table(paste(New.Breast.Primary, HER2.NP, Death, 
                       ifelse(is.na(T2NP), "noT2NP", "T2NP"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
#       NA:NA:No:noT2NP:noT2D:T2LFU NA:Negative:No:noT2NP:noT2D:noT2LFU 
#                                 4*                                   6* 
# NA:Negative:No:noT2NP:noT2D:T2LFU    NA:Negative:Yes:noT2NP:T2D:T2LFU 
#                                78*                                   6* 
#       No:NA:No:noT2NP:noT2D:T2LFU           No:NA:No:T2NP:noT2D:T2LFU 
#                                54*                                   1* 
#        No:NA:Yes:noT2NP:T2D:T2LFU No:Negative:No:noT2NP:noT2D:noT2LFU 
#                                 7*                                  12* 
# No:Negative:No:noT2NP:noT2D:T2LFU    No:Negative:Yes:noT2NP:T2D:T2LFU 
#                               404                                  14 
#        Yes:NA:No:T2NP:noT2D:T2LFU    Yes:Negative:No:T2NP:noT2D:T2LFU 
#                                 2*                                  13 
#   Yes:Negative:Yes:T2NP:T2D:T2LFU    Yes:Positive:No:T2NP:noT2D:T2LFU 
#                                 2                                   1 
# 170 (4+6+78+6+54+1+7+12+2) patients miss outcome information*

### T2LRDeath.ER: NA if LRDeath.ER is NA
###               `T2LR` if LRDeath.ER is LRYesERPos or LRYesERNeg
###               `T2Death` if LRDeath.ER is Dead
###               `T2LFU` if LRDeath.ER is Censored


### T2LRDeath.PR: NA if LRDeath.PR is NA
###               `T2LR` if LRDeath.PR is LRYesPRPos or LRYesPRNeg
###               `T2Death` if LRDeath.PR is Dead
###               `T2LFU` if LRDeath.PR is Censored


### T2LRDeath.HER2: NA if LRDeath.HER2 is NA
###                 `T2LR` if LRDeath.HER2 is LRYesHER2Pos or LRYesHER2Neg
###                 `T2Death` if LRDeath.HER2 is Dead
###                 `T2LFU` if LRDeath.HER2 is Censored


### T2NPDeath.ER: NA if NPDeath.ER is NA
###               `T2NP` if NPDeath.ER is NPYesERPos or NPYesERNeg
###               `T2Death` if NPDeath.ER is Dead
###               `T2LFU` if NPDeath.ER is Censored


### T2NPDeath.PR: NA if NPDeath.PR is NA
###               `T2NP` if NPDeath.PR is NPYesPRPos or NPYesPRNeg
###               `T2Death` if NPDeath.PR is Dead
###               `T2LFU` if NPDeath.PR is Censored


### T2NPDeath.HER2: NA if NPDeath.HER2 is NA
###                 `T2NP` if NPDeath.HER2 is NPYesHER2Pos or NPYesHER2Neg
###                 `T2Death` if NPDeath.HER2 is Dead
###                 `T2LFU` if NPDeath.HER2 is Censored
```


```{r analysis_plan_current, include=FALSE}
#################################################################
##                    Updated analysis plan                    ##
#################################################################
## ALiu: Create event variables where the dead and censored are combined as censor
### LRDeath2: NA if LRDeath is NA
###           "LocRecur" if LRDeath is LocRecur
###           "censor" if LRDeath is Dead or Censored

### DRDeath2: NA if DRDeath is NA
###           "DisRecur" if DRDeath is DisRecur
###           "censor" if DRDeath is Dead or Censored

### NPDeath2: NA if NPDeath is NA
###           "NBP" if NPDeath is NBP
###           "censor" if NPDeath is Dead or Censored

### LRDeath2.ER: NA if LRDeath.ER is NA
###              "LRYesERPos" if LRDeath.ER is LRYesERPos
###              "LRYesERNeg" if LRDeath.ER is LRYesERNeg
###              "censor" if LRDeath.ER is Dead or Censored

### LRDeath2.PR: NA if LRDeath.PR is NA
###              "LRYesPRPos" if LRDeath.PR is LRYesPRPos
###              "LRYesPRNeg" if LRDeath.PR is LRYesPRNeg
###              "censor" if LRDeath.PR is Dead or Censored

### LRDeath2.HER2: NA if LRDeath.HER2 is NA
###                "LRYesHER2Pos" if LRDeath.HER2 is LRYesHER2Pos
###                "LRYesHER2Neg" if LRDeath.HER2 is LRYesHER2Neg
###                "censor" if LRDeath.HER2 is Dead or Censored

### NPDeath2.ER: NA if NPDeath.ER is NA
###              "NPYesERPos" if NPDeath.ER is NPYesERPos
###              "NPYesERNeg" if NPDeath.ER is NPYesERNeg
###              "censor" if NPDeath.ER is Dead or Censored

### NPDeath2.PR: NA if NPDeath.PR is NA
###              "NPYesPRPos" if NPDeath.PR is NPYesPRPos
###              "NPYesPRNeg" if NPDeath.PR is NPYesPRNeg
###              "censor" if NPDeath.PR is Dead or Censored

### NPDeath2.HER2: NA if NPDeath.HER2 is NA
###                "NPYesHER2Pos" if NPDeath.HER2 is NPYesHER2Pos
###                "NPYesHER2Neg" if NPDeath.HER2 is NPYesHER2Neg
###                "censor" if NPDeath.HER2 is Dead or Censored
```

# Data preparation

```{r global_options, include=FALSE}
#################################################################
##                          Automator                          ##
#################################################################
if (params$plot.fig) {
  dir.fig <- paste0("../report/figs_", params$date)
  
  if (!dir.exists(dir.fig)) { 
    # If the figure directory does not exist, we create a new directory under the folder report using the name figs + current date passed from the params$date in YAML
    dir.create(dir.fig) 
  }
  
  knitr::opts_chunk$set( # Setting parameters when figures are plotted
    fig.width = 6, fig.height = 6, fig.path = dir.fig, dev = "png", dpi = 300,
    echo = FALSE, warning = FALSE, message = FALSE,
    cache = FALSE,
    comment = ""
  )
  
} else { # Setting parameters when figures are not plotted
  knitr::opts_chunk$set(
    echo = FALSE, warning = FALSE, message = FALSE,
    cache = FALSE,
    comment = ""
  )
}

if (params$results.folder) { # Suitable when the results need to be stored outside the microsoft word report
  dir.result <- paste0("../report/results_", params$date)
  
  if (!dir.exists(dir.result)) {
    # If the directory does not exist, we create a new directory under the folder report using the name results + current date passed from the params$date in YAML 
    
    dir.create(dir.result)
  }
}

loc.perl <- "C:/cygwin64/bin/perl" 
```


```{r clean_data_start, eval=FALSE}
##################################################################
##                          Clean data                          ##
##################################################################
dat0 <- read_xlsx(
  path = "../data/raw/TNBC WCM 1998-2018_Deidentified_Final_10_14_V2.xlsx",
  sheet = "TNBC no recurrence or new BC", 
  range = "A1:BL521",
  na = c("Unknown", "", "NA", "Not applicable ", "Not applicable", "Not aplicable", "n/a", "Unknown grade (not reported or unavailable)", "Unknown (not reported or unavailable)")) %>%
  select(-c("ER expression (%)", "PR expression (%)", "HER2/neu (IHC)", "HER2/neu (FISH)")) %>%
  mutate(ER.LR = "Negative",
         PR.LR = "Negative",
         HER2.LR = "Negative",
         ER.NP = "Negative",
         PR.NP = "Negative",
         HER2.NP = "Negative") %>%
  data.frame()

dat1 <- read_xlsx(
  path = "../data/raw/TNBC WCM 1998-2018_Deidentified_Final_10_14_V2.xlsx",
  sheet = "recurrence or new BC", 
  range = "A1:CE85",
  na = c("Unknown", "", "NA", "Not applicable ", "Not applicable", "Not aplicable", "n/a", "Unknown grade (not reported or unavailable)", "Unknown (not reported or unavailable)")) %>%
  data.frame()

var.rm <- c("Laterality.Primary", 
            "Laterality.local", 
            "Cancer.Type", 
            "ER.expression....",
            "PR.expression....",
            "HER2.neu..IHC.",
            "HER2.neu..FISH.",
            # "ER...60", # ER.LR
            "X....61", 
            # "PR...62", # PR.LR 
            "X....63", 
            # "HER2...64", # HER2.LR
            "IHC...65", 
            "FISH...66", 
            "Laterality.New", 
            "New.Path",
            # "ER...74", # ER.NP
            "X....75", 
            # "PR...76", # PR.NP
            "X....77", 
            # "HER2...78", # HER2.NP
            "IHC...79", 
            "FISH...80")

dat1 <- dat1 %>% 
  select(-var.rm) %>% 
  rename("Any.Local.Recurrence" = "Local.Recurrence",
         "ER.LR" = "ER...60",
         "PR.LR" = "PR...62",
         "HER2.LR" = "HER2...64",
         "ER.NP" = "ER...74",
         "PR.NP" = "PR...76",
         "HER2.NP" = "HER2...78") %>%
  select(everything(), 
         "Status.Last.Follow.up", 
         "Any.Local.Recurrence", 
         "Date.Local.Recurrence",
         "Any.Distant.Recurrence", 
         "Site.First.Distant.Recurrence", 
         "Date.First.Distant.Recurrence",
         "Any.New..subsequent..Br.1", 
         "Date.New.Breast.primary", 
         "Date.Death")

dat2 <- rbind(dat0, dat1)


##################################################################
##                       Fix column names                       ##
##################################################################
# Step1: strsplit(names(dat2), split = "\\.")
# Step2: paste(x[x != ""], collapse = ".")
# Step3: sapply

names(dat2) <- 
  sapply(strsplit(names(dat2), split = "\\."), function(x)
    paste(x[x != ""], collapse = "."))


#################################################################
##                    Clean data (continue)                    ##
#################################################################
# table(dat.full$Race.Ethnicity2, useNA = "always")
dat3 <- dat2 %>%
  mutate(
    Race.Ethnicity2 = gsub(".*Asian.*|Filipino|Korean", "Asian",
                           gsub("Hisp.*", "Hisp/Latina", 
                                gsub("White|NHW|Arabic*", "WA",   #xkz: added NHW and arabic
                                     gsub("American.*|Pacific.*", "Other", Race.Ethnicity)))) %>%
    factor(levels = c("WA", "AA", "Asian", "Hisp/Latina", "Other"))) %>%
  mutate(
    Race.Ethnicity3 = ifelse(Race.Ethnicity2 == "WA", "WA", "Other") %>%
      factor(levels = c("WA", "Other"))) %>%
  mutate( # NA: 86
    Local.Recurrence = gsub("Never.*", NA, Any.Local.Recurrence) %>%  #xkz: "Never Disease Free" needs to be counted separately probably better as NA here
      factor()) %>% 
  mutate( # NA: 80
    Distant.Recurrence = gsub("Never.*", NA, Any.Distant.Recurrence) %>% 
      factor()) %>%
  mutate( # NA: 94
    New.Breast.Primary = Any.New.subsequent.Br.1 %>%
      factor()) %>% 
  mutate(
    Clinical.T.Stage2 = gsub("T1a|T1b|T1c|T2", "T1|T2",
                             gsub("T3|T4", "T3|T4", Clinical.T.Stage))) %>% 
  mutate(
    Clinical.N.Stage2 = gsub("N1|N2|N3", "N1|N2|N3", Clinical.N.Stage))
```


```{r code_complex_variable, eval=FALSE}
#################################################################
##        Recode T2LR/T2DR/T2NP/T2Death/T2LFU (in days)        ##
#################################################################
dat3 <- dat3 %>% 
  mutate( # LR: local recurrence
    T2LR = as.numeric(as.Date(Date.Local.Recurrence) - as.Date(Date.of.Diagnosis))) %>%
  mutate( # DR: distant recurrence
    T2DR = as.numeric(as.Date(Date.First.Distant.Recurrence) - as.Date(Date.of.Diagnosis))) %>%
  mutate( # NP: new breast primary
    T2NP = as.numeric(as.Date(Date.New.Breast.primary) - as.Date(Date.of.Diagnosis))) %>%
  mutate(
    T2Death = as.numeric(as.Date(Date.Death) - as.Date(Date.of.Diagnosis))) %>% 
  mutate( # LFU: last follow up
    T2LFU = as.numeric(as.Date(Date.Last.Follow.up) - as.Date(Date.of.Diagnosis)))


##################################################################
##                    Check all T2 variables                    ##
##################################################################
## Avoid writing the following codes in the future.
# range(dat3$T2Death, na.rm = TRUE)
# range(dat3$T2DR, na.rm = TRUE)
# range(dat3$T2NP, na.rm = TRUE)
# range(dat3$T2LFU, na.rm = TRUE)

var <- c("T2Death", "T2DR", "T2NP", "T2LFU")
mclapply(1:4, 
         function(i){range(dat3[var[i]], na.rm = T)},
         mc.cores = 4)
# [[1]]
# [1]  106 4235
# 
# [[2]]
# [1]   178 12714
# 
# [[3]]
# [1]  232 4848
# 
# [[4]]
# [1]     0 13573


#################################################################
##           Recode LRFS.event/DRFS.event/NPFS.event           ##
#################################################################
dat3 <- dat3 %>% 
  mutate( # LRFS: local recurrence free survival
    LRFS.event = ifelse(Local.Recurrence == "Yes", 1, 0)) %>% 
  mutate( # DRFS: distant recurrence free survival
    DRFS.event = ifelse(Distant.Recurrence == "Yes", 1, 0)) %>%
  mutate( # NPFS: new breast primary free survival
    NPFS.event = ifelse(New.Breast.Primary == "Yes", 1, 0))


##################################################################
##             Recode LRFS.time/DRFS.time/NPFS.time             ##
##################################################################
table(paste(dat3$Local.Recurrence, 
            ifelse(is.na(dat3$T2LR), "noT2LR", "T2LR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2LR:noT2D:noT2LFU 6
# NA:noT2LR:noT2D:T2LFU 75
# NA:noT2LR:T2D:T2LFU 5
# No:noT2LR:noT2D:noT2LFU 12
# Yes:noT2LR:noT2D:T2LFU 2
# 100 patients miss outcome information

dat3 <- dat3 %>%
  mutate(
    LRFS.time = case_when(
      Local.Recurrence == "No" & !is.na(T2Death) & T2Death <= T2LFU ~ T2Death, # No:noT2LR:T2D:T2LFU
      Local.Recurrence == "No" & !is.na(T2Death) & T2Death > T2LFU ~ T2LFU, # No:noT2LR:T2D:T2LFU
      Local.Recurrence == "No" & is.na(T2Death) ~ T2LFU, # No:noT2LR:noT2D:noT2LFU; No:noT2LR:noT2D:T2LFU
      Local.Recurrence == "Yes" | is.na(Local.Recurrence) ~ T2LR)) # Yes:noT2LR:noT2D:T2LFU; Yes:T2LR:noT2D:T2LFU; Yes:T2LR:T2D:T2LFU; NA:noT2LR:noT2D:noT2LFU; NA:noT2LR:noT2D:T2LFU; NA:noT2LR:T2D:T2LFU

# Check the number of patients not at risk
summary(dat3$LRFS.time)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   #  0.0   557.2  1320.5  1739.5  2524.2 12694.0     100 
# 100 patients miss outcome information


table(paste(dat3$Distant.Recurrence, 
            ifelse(is.na(dat3$T2DR), "noT2DR", "T2DR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2DR:noT2D:noT2LFU 6
# NA:noT2DR:noT2D:T2LFU 69
# NA:noT2DR:T2D:T2LFU 5  
# No:noT2DR:noT2D:noT2LFU 11
# Yes:noT2DR:noT2D:noT2LFU 1
# Yes:noT2DR:noT2D:T2LFU 12
# Yes:noT2DR:T2D:T2LFU 1
# 105 patients miss outcome information

dat3 <- dat3 %>%
  mutate(
    DRFS.time = case_when(
      Distant.Recurrence == "No" & !is.na(T2Death) & T2Death <= T2LFU ~ T2Death, 
      Distant.Recurrence == "No" & !is.na(T2Death) & T2Death > T2LFU ~ T2LFU, 
      Distant.Recurrence == "No" & is.na(T2Death) ~ T2LFU,  
      Distant.Recurrence == "Yes" | is.na(Distant.Recurrence) ~ T2DR)) 

# Check the number of patients not at risk
summary(dat3$DRFS.time)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#    0.0   579.5  1376.0  1833.1  2701.0 12714.0     105 


table(paste(dat3$New.Breast.Primary, 
            ifelse(is.na(dat3$T2NP), "noT2NP", "T2NP"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2NP:noT2D:noT2LFU 6
# NA:noT2NP:noT2D:T2LFU 82
# NA:noT2NP:T2D:T2LFU 6  
# No:noT2NP:noT2D:noT2LFU 12
# 106 patients miss outcome information

dat3 <- dat3 %>% 
  mutate(
    NPFS.time = case_when(
      New.Breast.Primary == "No" & !is.na(T2Death) & T2Death <= T2LFU ~ T2Death, 
      New.Breast.Primary == "No" & !is.na(T2Death) & T2Death > T2LFU ~ T2LFU, 
      New.Breast.Primary == "No" & is.na(T2Death) ~ T2LFU,  
      New.Breast.Primary == "Yes" | is.na(New.Breast.Primary) ~ T2NP)) 

# Check the number of patients not at risk
summary(dat3$NPFS.time)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#    0.0   609.8  1351.0  1822.8  2697.2 13573.0     106 
# 106 patients miss outcome information

#################################################################
##                    Recode LR5y/DR5y/NP5y                    ##
#################################################################
# dat3$LR5y <- dat3$Local.Recurrence # Factor variable
# dat3$DR5y <- dat3$Distant.Recurrence
# dat3$NP5y <- dat3$New.Breast.Primary

dat3$LR5y = dat3$DR5y = dat3$NP5y = rep(0, times = nrow(dat3))
  
criter1 <- with(dat3, LRFS.event == 1 & !is.na(T2LR) & T2LR < 365.25*5)
table(criter1, useNA = "ifany")
# NA is not a value; R deal with NA separately
# criter1
# FALSE  TRUE 
#  549    55 
criter2 <- with(dat3, LRFS.event == 0 & !is.na(LRFS.time) & LRFS.time < 365.25*5) 
table(criter2, useNA = "ifany")
# criter2
# FALSE  TRUE 
#  344   260 
dat3$LR5y[criter1] <- 1
dat3$LR5y[criter2] <- NA
table(dat3$LR5y, useNA = "ifany")
#   0    1 <NA> 
# 289   55  260 


criter1 <- with(dat3, DRFS.event == 1 & !is.na(T2DR) & T2DR < 365.25*5)
table(criter1, useNA = "ifany")
# criter1
# FALSE  TRUE 
#  557    47 
criter2 <- with(dat3, DRFS.event == 0 & !is.na(DRFS.time) & DRFS.time < 365.25*5) 
table(criter2, useNA = "ifany")
# criter2
# FALSE  TRUE 
#  355   249 
dat3$DR5y[criter1] <- 1
dat3$DR5y[criter2] <- NA
table(dat3$DR5y, useNA = "ifany")
#   0    1 <NA> 
# 308   47  249 


criter1 <- with(dat3, NPFS.event == 1 & !is.na(T2NP) & T2NP < 365.25*5)
table(criter1, useNA = "ifany")
# criter1
# FALSE  TRUE 
#  591    13 
criter2 <- with(dat3, NPFS.event == 0 & !is.na(NPFS.time) & NPFS.time < 365.25*5) 
table(criter2, useNA = "ifany")
# criter2
# FALSE  TRUE 
#  322   282 
dat3$NP5y[criter1] <- 1
dat3$NP5y[criter2] <- NA
table(dat3$NP5y, useNA = "ifany")
#   0    1 <NA> 
# 309   13  282 

##################################################################
##                         Recode Death                         ##
##################################################################
dat3$Death <- ifelse(!is.na(dat3$Date.Death), "Yes", "No")


##################################################################
##                        Recode LRDeath                        ##
##################################################################
table(paste(dat3$Local.Recurrence, 
            ifelse(is.na(dat3$T2LR), "noT2LR", "T2LR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2LR:noT2D:noT2LFU 6
# NA:noT2LR:noT2D:T2LFU 75
# NA:noT2LR:T2D:T2LFU 5
# No:noT2LR:noT2D:noT2LFU 12
# Yes:noT2LR:noT2D:T2LFU 2
# 100 patients miss outcome information

table(dat3$Local.Recurrence, dat3$Death, useNA = "ifany")
#       No Yes
# No   431  15
# Yes   63   9
# <NA>  81   5

dat3[dat3$Local.Recurrence == "Yes" & !is.na(dat3$Local.Recurrence) & dat3$Death == "Yes" & !is.na(dat3$Death), c("T2LR", "T2Death")]
#   T2LR T2Death
# 564  276     396
# 580  374     410
# 581 2373    4235
# 582 1922    3535
# 583  445     818
# 586 2498    3415
# 589  392     532
# 596 1116    1948
# 604  312     464

dat3 <- dat3 %>% 
  mutate(LRDeath = case_when(is.na(Local.Recurrence) & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             is.na(Local.Recurrence) & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             is.na(Local.Recurrence) & is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Local.Recurrence == "No" & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             Local.Recurrence == "Yes" & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Local.Recurrence == "Yes" & Death == "No" ~ "LocRecur",
                             Local.Recurrence == "Yes" & Death == "Yes" ~ "LocRecur",
                             Death == "Yes" & Local.Recurrence == "No" ~ "Dead",
                             Local.Recurrence == "No" & Death == "No" ~ "Censored") %>%
  factor(levels = c("Censored", "LocRecur", "Dead")))

table(dat3$LRDeath, useNA = "ifany")
# Censored     Dead LocRecur     <NA> 
#      419       15       70      100 


##################################################################
##                        Recode DRDeath                        ##
##################################################################
table(paste(dat3$Distant.Recurrence, 
            ifelse(is.na(dat3$T2DR), "noT2DR", "T2DR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2DR:noT2D:noT2LFU 6
# NA:noT2DR:noT2D:T2LFU 69
# NA:noT2DR:T2D:T2LFU 5  
# No:noT2DR:noT2D:noT2LFU 11
# Yes:noT2DR:noT2D:noT2LFU 1
# Yes:noT2DR:noT2D:T2LFU 12
# Yes:noT2DR:T2D:T2LFU 1
# 105 patients miss outcome information

table(dat3$Distant.Recurrence, dat3$Death, useNA = "ifany")
#       No Yes
# No   441  13
# Yes   59  11
# <NA>  75   5

dat3[dat3$Distant.Recurrence == "Yes" & !is.na(dat3$Distant.Recurrence) & dat3$Death == "Yes" & !is.na(dat3$Death), c("T2DR", "T2Death")]
#     T2DR T2Death
# 237  903    1485
# 239 1120    1301
# 371  578    1091
# 520  447     550
# 564  276     396
# 581 3592    4235
# 582 3407    3535
# 583  446     818
# 586 3297    3415
# 589  392     532
# 596   NA    1948

dat3 <- dat3 %>% 
  mutate(DRDeath = case_when(is.na(Distant.Recurrence) & is.na(T2DR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             is.na(Distant.Recurrence) & is.na(T2DR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             is.na(Distant.Recurrence) & is.na(T2DR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "No" & is.na(T2DR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & is.na(T2DR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & is.na(T2DR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & is.na(T2DR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & Death == "No" ~ "DisRecur",
                             Distant.Recurrence == "Yes" & Death == "Yes" ~ "DisRecur",
                             Death == "Yes" & Distant.Recurrence == "No" ~ "Dead",
                             Distant.Recurrence == "No" & Death == "No" ~ "Censored") %>%
  factor(levels = c("Censored", "DisRecur", "Dead"))
)

table(dat3$DRDeath, useNA = "ifany")
# Censored     Dead DisRecur     <NA> 
#      430       13       56      105 


##################################################################
##                        Recode NPDeath                        ##
##################################################################
table(paste(dat3$New.Breast.Primary, 
            ifelse(is.na(dat3$T2NP), "noT2NP", "T2NP"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2NP:noT2D:noT2LFU 6
# NA:noT2NP:noT2D:T2LFU 82
# NA:noT2NP:T2D:T2LFU 6  
# No:noT2NP:noT2D:noT2LFU 12
# 106 patients miss outcome information

table(dat3$New.Breast.Primary, dat3$Death, useNA = "ifany")
#       No Yes
# No   471  21
# Yes   16   2
# <NA>  88   6

dat3[dat3$New.Breast.Primary == "Yes" & !is.na(dat3$New.Breast.Primary) & dat3$Death == "Yes" & !is.na(dat3$Death), c("T2NP", "T2Death")]
#     T2NP T2Death
# 564  287     396
# 582 2723    3535

dat3 <- dat3 %>% 
  mutate(NPDeath = case_when(is.na(New.Breast.Primary) & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             is.na(New.Breast.Primary) & is.na(T2NP) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             is.na(New.Breast.Primary) & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             New.Breast.Primary == "No" & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             New.Breast.Primary == "Yes" & Death == "No" ~ "NBP",
                             New.Breast.Primary == "Yes" & Death == "Yes" ~ "NBP",
                             Death == "Yes" & New.Breast.Primary == "No" ~ "Dead",
                             New.Breast.Primary == "No" & Death == "No" ~ "Censored") %>%
  factor(levels = c("Censored", "NBP", "Dead"))
)

table(dat3$NPDeath, useNA = "ifany")
# Censored     Dead      NBP     <NA> 
#      459       21       18      106 


##################################################################
##             Recode T2LRDeath/T2DRDeath/T2NPDeath             ##
##################################################################
dat3 <- dat3 %>% 
  mutate(T2LRDeath = case_when(LRDeath == "LocRecur" ~ T2LR,
                               LRDeath == "Dead" ~ T2Death,
                               LRDeath == "Censored" ~ T2LFU)) %>% 
  mutate(T2DRDeath = case_when(DRDeath == "DisRecur" ~ T2DR,
                               DRDeath == "Dead" ~ T2Death,
                               DRDeath == "Censored" ~ T2LFU)) %>% 
  mutate(T2NPDeath = case_when(NPDeath == "NBP" ~ T2NP,
                               NPDeath == "Dead" ~ T2Death,
                               NPDeath == "Censored" ~ T2LFU))

## Avoid writing the following codes in the future.
# sum(is.na(T2LRDeath))
# sum(is.na(T2DRDeath))
# sum(is.na(T2NPDeath))

sum.na <- function(x) {is.na(x) %>% sum()}
var <- c("T2LRDeath", "T2DRDeath", "T2NPDeath")
mclapply(1:3, 
         function(i){sum.na(dat3[var[i]])},
         mc.cores = 4L)

# [[1]]
# [1] 100
# 
# [[2]]
# [1] 105
# 
# [[3]]
# [1] 106


#################################################################
##                      Recode LRDeath.ER                      ##
#################################################################
c1 <- with(dat3, formula("is.na(Local.Recurrence) & ER.LR == 'Negative' & Death == 'No' & is.na(T2LR) & is.na(T2Death) ~ as.character(NA)")) # NA:Negative:No:noT2LR:noT2D:noT2LFU & # NA:Negative:No:noT2LR:noT2D:T2LFU 

c2 <- with(dat3, formula("is.na(Local.Recurrence) & ER.LR == 'Negative' & Death == 'Yes' & is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:Negative:Yes:noT2LR:T2D:T2LFU

c3 <- with(dat3, formula("Local.Recurrence == 'No' & is.na(ER.LR) & Death == 'No' & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:No:noT2LR:noT2D:T2LFU 

c4 <- with(dat3, formula("Local.Recurrence == 'No' & ER.LR == 'Negative' & Death == 'No' & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # No:Negative:No:noT2LR:noT2D:noT2LFU

c5 <- with(dat3, formula("Local.Recurrence == 'Yes' & ER.LR %in% c(NA, 'Positive') & Death == 'No' & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:noT2LR:noT2D:T2LFU & Yes:Positive:No:noT2LR:noT2D:T2LFU

c6 <- with(dat3, formula("Local.Recurrence == 'Yes' & is.na(ER.LR) & Death == 'Yes' & !is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:Yes:T2LR:T2D:T2LFU

dat3 <- dat3 %>% 
  mutate(LRDeath.ER = case_when(c1, c2, c3, c4, c5, c6, # Conditions for patients not at risk
                                Local.Recurrence == "Yes" & ER.LR == "Positive" & Death %in% c("Yes", "No") ~ "LRYesERPos",
                                Local.Recurrence == "Yes" & ER.LR == "Negative" & Death %in% c("Yes", "No") ~ "LRYesERNeg",
                                Death == "Yes" & Local.Recurrence == "No" ~ "Dead",
                                Local.Recurrence == "No" & Death == "No" & !is.na(T2LFU) ~ "Censored") %>%
           factor(levels = c("Censored", "LRYesERPos", "LRYesERNeg", "Dead")))
                                

table(dat3$LRDeath.ER, useNA = "ifany")
  # Censored LRYesERPos LRYesERNeg       Dead 
  #      407          8         61         15 
  #     <NA> 
  #      113 

with(dat3, table(paste(LRDeath.ER, 
                       ifelse(is.na(T2LR), "noT2LR", "T2LR"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# Censored:noT2LR:noT2D:T2LFU       Dead:noT2LR:T2D:T2LFU 
#                         407                          15 
# LRYesERNeg:T2LR:noT2D:T2LFU   LRYesERNeg:T2LR:T2D:T2LFU 
#                          54                           7 
# LRYesERPos:T2LR:noT2D:T2LFU   LRYesERPos:T2LR:T2D:T2LFU 
#                           7                           1 
#     NA:noT2LR:noT2D:noT2LFU       NA:noT2LR:noT2D:T2LFU 
#                          18                          89 
#         NA:noT2LR:T2D:T2LFU           NA:T2LR:T2D:T2LFU 
#                           5                           1 


#################################################################
##                      Recode LRDeath.PR                      ##
#################################################################
c1 <- with(dat3, formula("is.na(Local.Recurrence) & PR.LR == 'Negative' & Death == 'No' & is.na(T2LR) & is.na(T2Death) ~ as.character(NA)")) # NA:Negative:No:noT2LR:noT2D:noT2LFU & # NA:Negative:No:noT2LR:noT2D:T2LFU 
c2 <- with(dat3, formula("is.na(Local.Recurrence) & PR.LR == 'Negative' & Death == 'Yes' & is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:Negative:Yes:noT2LR:T2D:T2LFU  
c3 <- with(dat3, formula("Local.Recurrence == 'No' & is.na(PR.LR) & Death == 'No' & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:No:noT2LR:noT2D:T2LFU 
c4 <- with(dat3, formula("Local.Recurrence == 'No' & PR.LR == 'Negative' & Death == 'No' & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # No:Negative:No:noT2LR:noT2D:noT2LFU
c5 <- with(dat3, formula("Local.Recurrence == 'Yes' & PR.LR %in% c(NA, 'Negative') & Death == 'No' & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:noT2LR:noT2D:T2LFU & Yes:Negative:No:noT2LR:noT2D:T2LFU
c6 <- with(dat3, formula("Local.Recurrence == 'Yes' & is.na(PR.LR) & Death == 'Yes' & !is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:Yes:T2LR:T2D:T2LFU

dat3 <- dat3 %>% 
  mutate(LRDeath.PR = case_when(c1, c2, c3, c4, c5, c6, # Conditions for patients not at risk
                                Local.Recurrence == "Yes" & PR.LR == "Positive" & Death %in% c("Yes", "No") ~ "LRYesPRPos",
                                Local.Recurrence == "Yes" & PR.LR == "Negative" & Death %in% c("Yes", "No") ~ "LRYesPRNeg",
                                Death == "Yes" & Local.Recurrence == "No" ~ "Dead",
                                Local.Recurrence == "No" & Death == "No" & !is.na(T2LFU) ~ "Censored") %>%
           factor(levels = c("Censored", "LRYesPRPos", "LRYesPRNeg", "Dead")))

table(dat3$LRDeath.PR, useNA = "ifany") 
  # Censored LRYesPRPos LRYesPRNeg       Dead       <NA> 
  #      407          5         64         15        113 

with(dat3, table(paste(LRDeath.PR, 
                       ifelse(is.na(T2LR), "noT2LR", "T2LR"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# Censored:noT2LR:noT2D:T2LFU       Dead:noT2LR:T2D:T2LFU 
#                         407                          15 
# LRYesPRNeg:T2LR:noT2D:T2LFU   LRYesPRNeg:T2LR:T2D:T2LFU 
#                          56                           8 
# LRYesPRPos:T2LR:noT2D:T2LFU     NA:noT2LR:noT2D:noT2LFU 
#                           5                          18 
#       NA:noT2LR:noT2D:T2LFU         NA:noT2LR:T2D:T2LFU 
#                          89                           5 
#           NA:T2LR:T2D:T2LFU 
#                           1 


#################################################################
##                     Recode LRDeath.HER2                     ##
#################################################################
c1 <- with(dat3, formula("is.na(Local.Recurrence) & HER2.LR == 'Negative' & Death == 'No' & is.na(T2LR) & is.na(T2Death) ~ as.character(NA)")) # NA:Negative:No:noT2LR:noT2D:noT2LFU & # NA:Negative:No:noT2LR:noT2D:T2LFU 
c2 <- with(dat3, formula("is.na(Local.Recurrence) & HER2.LR == 'Negative' & Death == 'Yes' & is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:Negative:Yes:noT2LR:T2D:T2LFU  
c3 <- with(dat3, formula("Local.Recurrence == 'No' & is.na(HER2.LR) & Death == 'No' & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:No:noT2LR:noT2D:T2LFU 
c4 <- with(dat3, formula("Local.Recurrence == 'No' & HER2.LR == 'Negative' & Death == 'No' & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # No:Negative:No:noT2LR:noT2D:noT2LFU
c5 <- with(dat3, formula("Local.Recurrence == 'Yes' & HER2.LR %in% c(NA, 'Negative') & Death == 'No' & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:noT2LR:noT2D:T2LFU & Yes:Negative:No:noT2LR:noT2D:T2LFU
c6 <- with(dat3, formula("Local.Recurrence == 'Yes' & is.na(HER2.LR) & Death == 'Yes' & !is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:Yes:T2LR:T2D:T2LFU
c7 <- with(dat3, formula("Local.Recurrence == 'Yes' & is.na(HER2.LR) & Death == 'No' & !is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:T2LR:noT2D:T2LFU
dat3 <- dat3 %>% 
  mutate(LRDeath.HER2 = case_when(c1, c2, c3, c4, c5, c6, c7, # Conditions for patients not at risk
                                Local.Recurrence == "Yes" & HER2.LR == "Positive" & Death %in% c("Yes", "No") ~ "LRYesHER2Pos",
                                Local.Recurrence == "Yes" & HER2.LR == "Negative" & Death %in% c("Yes", "No") ~ "LRYesHER2Neg",
                                Death == "Yes" & Local.Recurrence == "No" ~ "Dead",
                                Local.Recurrence == "No" & Death == "No" & !is.na(T2LFU) ~ "Censored") %>%
           factor(levels = c("Censored", "LRYesHER2Pos", "LRYesHER2Neg", "Dead")))

table(dat3$LRDeath.HER2, useNA = "ifany") 
    # Censored LRYesHER2Pos LRYesHER2Neg         Dead         <NA> 
    #      407            1           63           15          118 

with(dat3, table(paste(LRDeath.HER2, 
                       ifelse(is.na(T2LR), "noT2LR", "T2LR"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
#   Censored:noT2LR:noT2D:T2LFU         Dead:noT2LR:T2D:T2LFU 
#                           407                            15 
# LRYesHER2Neg:T2LR:noT2D:T2LFU   LRYesHER2Neg:T2LR:T2D:T2LFU 
#                            56                             7 
# LRYesHER2Pos:T2LR:noT2D:T2LFU       NA:noT2LR:noT2D:noT2LFU 
#                             1                            18 
#         NA:noT2LR:noT2D:T2LFU           NA:noT2LR:T2D:T2LFU 
#                            89                             5 
#           NA:T2LR:noT2D:T2LFU             NA:T2LR:T2D:T2LFU 
#                             4                             2 


#################################################################
##                      Recode NPDeath.ER                      ##
#################################################################
c1 <- with(dat3, formula("is.na(New.Breast.Primary) & is.na(ER.NP) & Death == 'No' & is.na(T2NP) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:NA:No:noT2NP:noT2D:T2LFU
c2 <- with(dat3, formula("is.na(New.Breast.Primary) & ER.NP == 'Negative' & Death == 'No' & is.na(T2NP) & is.na(T2Death) ~ as.character(NA)")) # NA:Negative:No:noT2NP:noT2D:noT2LFU & # NA:Negative:No:noT2NP:noT2D:T2LFU 
c3 <- with(dat3, formula("is.na(New.Breast.Primary) & ER.NP == 'Negative' & Death == 'Yes' & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:Negative:Yes:noT2NP:T2D:T2LFU
c4 <- with(dat3, formula("New.Breast.Primary == 'No' & is.na(ER.NP) & Death == 'No' & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:No:noT2NP:noT2D:T2LFU & # No:NA:No:T2NP:noT2D:T2LFU 
c5 <- with(dat3, formula("New.Breast.Primary == 'No' & is.na(ER.NP) & Death == 'Yes' & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:Yes:noT2NP:T2D:T2LFU
c6 <- with(dat3, formula("New.Breast.Primary == 'No' & ER.NP == 'Negative' & Death == 'No' & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # No:Negative:No:noT2NP:noT2D:noT2LFU
c7 <- with(dat3, formula("New.Breast.Primary == 'Yes' & is.na(ER.NP) & Death == 'No' & is.na(T2NP) & !is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:T2NP:noT2D:T2LFU
dat3 <- dat3 %>% 
  mutate(NPDeath.ER = case_when(c1, c2, c3, c4, c5, c6, c7, # Conditions for patients not at risk
                                New.Breast.Primary == "Yes" & ER.NP == "Positive" & Death %in% c("Yes", "No") ~ "NPYesERPos",
                                New.Breast.Primary == "Yes" & ER.NP == "Negative" & Death %in% c("Yes", "No") ~ "NPYesERNeg",
                                Death == "Yes" & New.Breast.Primary == "No" ~ "Dead",
                                New.Breast.Primary == "No" & Death == "No" & !is.na(T2LFU) ~ "Censored") %>%
           factor(levels = c("Censored", "NPYesERPos", "NPYesERNeg", "Dead")))

table(dat3$NPDeath.ER, useNA = "ifany")
  # Censored NPYesERPos NPYesERNeg       Dead       <NA> 
  #      404         11          6         14        169 

with(dat3, table(paste(NPDeath.ER, 
                       ifelse(is.na(T2NP), "noT2NP", "T2NP"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# Censored:noT2NP:noT2D:T2LFU       Dead:noT2NP:T2D:T2LFU 
#                         404                          14 
#     NA:noT2NP:noT2D:noT2LFU       NA:noT2NP:noT2D:T2LFU 
#                          18                         136 
#         NA:noT2NP:T2D:T2LFU         NA:T2NP:noT2D:T2LFU 
#                          13                           2 
# NPYesERNeg:T2NP:noT2D:T2LFU   NPYesERNeg:T2NP:T2D:T2LFU 
#                           4                           2 
# NPYesERPos:T2NP:noT2D:T2LFU 
#                          11 


#################################################################
##                      Recode NPDeath.PR                      ##
#################################################################
c1 <- with(dat3, formula("is.na(New.Breast.Primary) & is.na(PR.NP) & Death == 'No' & is.na(T2NP) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:NA:No:noT2NP:noT2D:T2LFU
c2 <- with(dat3, formula("is.na(New.Breast.Primary) & PR.NP == 'Negative' & Death == 'No' & is.na(T2NP) & is.na(T2Death) ~ as.character(NA)")) # NA:Negative:No:noT2NP:noT2D:noT2LFU & # NA:Negative:No:noT2NP:noT2D:T2LFU 
c3 <- with(dat3, formula("is.na(New.Breast.Primary) & PR.NP == 'Negative' & Death == 'Yes' & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:Negative:Yes:noT2NP:T2D:T2LFU
c4 <- with(dat3, formula("New.Breast.Primary == 'No' & is.na(PR.NP) & Death == 'No' & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:No:noT2NP:noT2D:T2LFU & # No:NA:No:T2NP:noT2D:T2LFU 
c5 <- with(dat3, formula("New.Breast.Primary == 'No' & is.na(PR.NP) & Death == 'Yes' & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:Yes:noT2NP:T2D:T2LFU
c6 <- with(dat3, formula("New.Breast.Primary == 'No' & PR.NP == 'Negative' & Death == 'No' & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # No:Negative:No:noT2NP:noT2D:noT2LFU
c7 <- with(dat3, formula("New.Breast.Primary == 'Yes' & is.na(PR.NP) & Death == 'No' & is.na(T2NP) & !is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:T2NP:noT2D:T2LFU
dat3 <- dat3 %>% 
  mutate(NPDeath.PR = case_when(c1, c2, c3, c4, c5, c6, c7, # Conditions for patients not at risk
                                New.Breast.Primary == "Yes" & PR.NP == "Positive" & Death %in% c("Yes", "No") ~ "NPYesPRPos",
                                New.Breast.Primary == "Yes" & PR.NP == "Negative" & Death %in% c("Yes", "No") ~ "NPYesPRNeg",
                                Death == "Yes" & New.Breast.Primary == "No" ~ "Dead",
                                New.Breast.Primary == "No" & Death == "No" & !is.na(T2LFU) ~ "Censored") %>%
           factor(levels = c("Censored", "NPYesPRPos", "NPYesPRNeg", "Dead")))

table(dat3$NPDeath.PR, useNA = "ifany")
  # Censored NPYesPRPos NPYesPRNeg       Dead       <NA> 
  #      404          8          9         14        169 

with(dat3, table(paste(NPDeath.PR, 
                       ifelse(is.na(T2NP), "noT2NP", "T2NP"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
# Censored:noT2NP:noT2D:T2LFU       Dead:noT2NP:T2D:T2LFU     NA:noT2NP:noT2D:noT2LFU 
#                         404                          14                          18 
#       NA:noT2NP:noT2D:T2LFU         NA:noT2NP:T2D:T2LFU         NA:T2NP:noT2D:T2LFU 
#                         136                          13                           2 
# NPYesPRNeg:T2NP:noT2D:T2LFU   NPYesPRNeg:T2NP:T2D:T2LFU NPYesPRPos:T2NP:noT2D:T2LFU 
#                           7                           2                           8 


#################################################################
##                     Recode NPDeath.HER2                     ##
#################################################################
c1 <- with(dat3, formula("is.na(New.Breast.Primary) & is.na(HER2.NP) & Death == 'No' & is.na(T2NP) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:NA:No:noT2NP:noT2D:T2LFU
c2 <- with(dat3, formula("is.na(New.Breast.Primary) & HER2.NP == 'Negative' & Death == 'No' & is.na(T2NP) & is.na(T2Death) ~ as.character(NA)")) # NA:Negative:No:noT2NP:noT2D:noT2LFU & # NA:Negative:No:noT2NP:noT2D:T2LFU 
c3 <- with(dat3, formula("is.na(New.Breast.Primary) & HER2.NP == 'Negative' & Death == 'Yes' & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # NA:Negative:Yes:noT2NP:T2D:T2LFU
c4 <- with(dat3, formula("New.Breast.Primary == 'No' & is.na(HER2.NP) & Death == 'No' & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:No:noT2NP:noT2D:T2LFU & # No:NA:No:T2NP:noT2D:T2LFU 
c5 <- with(dat3, formula("New.Breast.Primary == 'No' & is.na(HER2.NP) & Death == 'Yes' & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA)")) # No:NA:Yes:noT2NP:T2D:T2LFU
c6 <- with(dat3, formula("New.Breast.Primary == 'No' & HER2.NP == 'Negative' & Death == 'No' & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # No:Negative:No:noT2NP:noT2D:noT2LFU
c7 <- with(dat3, formula("New.Breast.Primary == 'Yes' & is.na(HER2.NP) & Death == 'No' & is.na(T2NP) & !is.na(T2Death) & is.na(T2LFU) ~ as.character(NA)")) # Yes:NA:No:T2NP:noT2D:T2LFU
dat3 <- dat3 %>% 
  mutate(NPDeath.HER2 = case_when(c1, c2, c3, c4, c5, c6, c7, # Conditions for patients not at risk
                                New.Breast.Primary == "Yes" & HER2.NP == "Positive" & Death %in% c("Yes", "No") ~ "NPYesHER2Pos",
                                New.Breast.Primary == "Yes" & HER2.NP == "Negative" & Death %in% c("Yes", "No") ~ "NPYesHER2Neg",
                                Death == "Yes" & New.Breast.Primary == "No" ~ "Dead",
                                New.Breast.Primary == "No" & Death == "No" & !is.na(T2LFU) ~ "Censored") %>%
           factor(levels = c("Censored", "NPYesHER2Pos", "NPYesHER2Neg", "Dead")))

table(dat3$NPDeath.HER2, useNA = "ifany")
  # Censored NPYesHER2Pos NPYesHER2Neg         Dead         <NA> 
  #      404            1           15           14          170 

with(dat3, table(paste(NPDeath.HER2, 
                       ifelse(is.na(T2NP), "noT2NP", "T2NP"),
                       ifelse(is.na(T2Death), "noT2D", "T2D"),
                       ifelse(is.na(T2LFU), "noT2LFU", "T2LFU"),
                       sep = ":")))
#   Censored:noT2NP:noT2D:T2LFU         Dead:noT2NP:T2D:T2LFU       NA:noT2NP:noT2D:noT2LFU 
#                           404                            14                            18 
#         NA:noT2NP:noT2D:T2LFU           NA:noT2NP:T2D:T2LFU           NA:T2NP:noT2D:T2LFU 
#                           136                            13                             3 
# NPYesHER2Neg:T2NP:noT2D:T2LFU   NPYesHER2Neg:T2NP:T2D:T2LFU NPYesHER2Pos:T2NP:noT2D:T2LFU 
#                            13                             2                             1 

#################################################################
##       Recode T2LRDeath.ER/T2LRDeath.PR/T2LRDeath.HER2       ##
#################################################################
dat3 <- dat3 %>% 
  mutate(T2LRDeath.ER = case_when(LRDeath.ER %in% c("LRYesERPos", "LRYesERNeg") ~ T2LR,
                                  LRDeath.ER == "Dead" ~ T2Death,
                                  LRDeath.ER == "Censored" ~ T2LFU))
dat3 <- dat3 %>% 
  mutate(T2LRDeath.PR = case_when(LRDeath.PR %in% c("LRYesPRPos", "LRYesPRNeg") ~ T2LR,
                                  LRDeath.PR == "Dead" ~ T2Death,
                                  LRDeath.PR == "Censored" ~ T2LFU))
dat3 <- dat3 %>% 
  mutate(T2LRDeath.HER2 = case_when(LRDeath.HER2 %in% c("LRYesHER2Pos", "LRYesHER2Neg") ~ T2LR,
                                  LRDeath.HER2 == "Dead" ~ T2Death,
                                  LRDeath.HER2 == "Censored" ~ T2LFU))

var <- c("T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2")
sapply(var, function(x) sum.na(dat3[x]) )
  # T2LRDeath.ER   T2LRDeath.PR T2LRDeath.HER2 
  #          113            113            118 


#################################################################
##       Recode T2NPDeath.ER/T2NPDeath.PR/T2NPDeath.HER2       ##
#################################################################
dat3 <- dat3 %>% 
  mutate(T2NPDeath.ER = case_when(NPDeath.ER %in% c("NPYesERPos", "NPYesERNeg") ~ T2NP,
                                  NPDeath.ER == "Dead" ~ T2Death,
                                  NPDeath.ER == "Censored" ~ T2LFU))
dat3 <- dat3 %>% 
  mutate(T2NPDeath.PR = case_when(NPDeath.PR %in% c("NPYesPRPos", "NPYesPRNeg") ~ T2NP,
                                  NPDeath.PR == "Dead" ~ T2Death,
                                  NPDeath.PR == "Censored" ~ T2LFU))
dat3 <- dat3 %>% 
  mutate(T2NPDeath.HER2 = case_when(NPDeath.HER2 %in% c("NPYesHER2Pos", "NPYesHER2Neg") ~ T2NP,
                                    NPDeath.HER2 == "Dead" ~ T2Death,
                                    NPDeath.HER2 == "Censored" ~ T2LFU))
var <- c("T2NPDeath.ER", "T2NPDeath.PR", "T2NPDeath.HER2")
sapply(var, function(x) sum.na(dat3[x]) )
  # T2NPDeath.ER   T2NPDeath.PR T2NPDeath.HER2 
  #          169            169            170 

######################################################################
##  Recode LRDeath2/DRDeath2/NPDeath2 - combine death and censored  ##
######################################################################
# The function Surv() {survival} tries to distinguish between the use of 0/1 and 1/2 coding for censored data via the condition if (max(status)==2). If 1/2 coding is used and all the subjects are censored, it will guess wrong. In any questionable case it is safer to use logical coding, e.g., Surv(time, status==3) would indicate that '3' is the code for an event. For multi-state survival the status variable will be a factor, whose first level is assumed to correspond to censoring (https://stat.ethz.ch/R-manual/R-devel/library/survival/html/Surv.html).

# Formula with Surv() {tidycmprsk} on LHS and covariates on RHS. The event status variable must be a factor, with the first level indicating 'censor' and subsequent levels the competing risks. The Surv(time2=) argument cannot be used.

dat3$LRDeath2 <- case_when(dat3$LRDeath %in% c("Dead", "Censored") ~ "censor",
                           TRUE ~ as.character(dat3$LRDeath)) %>% 
  factor(levels = c("censor", "LocRecur"))

dat3$DRDeath2 <- case_when(dat3$DRDeath == c("Dead", "Censored") ~ "censor",
                           TRUE ~ as.character(dat3$DRDeath)) %>% 
  factor(levels = c("censor", "DisRecur"))

dat3$NPDeath2 <- case_when(dat3$NPDeath == c("Dead", "Censored") ~ "censor",
                           TRUE ~ as.character(dat3$NPDeath)) %>% 
  factor(levels = c("censor", "NBP"))

#################################################################################
##  Recode LRDeath2.ER/LRDeath2.PR/LRDeath2.HER2 - combine death and censored  ##
#################################################################################
dat3$LRDeath2.ER <- case_when(dat3$LRDeath.ER %in% c("Dead", "Censored") ~ "censor",
                              TRUE ~ as.character(dat3$LRDeath.ER)) %>% 
  factor(levels = c("censor", "LRYesERPos", "LRYesERNeg"))

dat3$LRDeath2.PR <- case_when(dat3$LRDeath.PR %in% c("Dead", "Censored") ~ "censor",
                              TRUE ~ as.character(dat3$LRDeath.PR)) %>% 
  factor(levels = c("censor", "LRYesPRPos", "LRYesPRNeg"))

dat3$LRDeath2.HER2 <- case_when(dat3$LRDeath.HER2 %in% c("Dead", "Censored") ~ "censor",
                                TRUE ~ as.character(dat3$LRDeath.HER2)) %>% 
  factor(levels = c("censor", "LRYesHER2Pos", "LRYesHER2Neg"))


#################################################################################
##  Recode NPDeath2.ER/NPDeath2.PR/NPDeath2.HER2 - combine death and censored  ##
#################################################################################
dat3$NPDeath2.ER <- case_when(dat3$NPDeath.ER %in% c("Dead", "Censored") ~ "censor",
                              TRUE ~ as.character(dat3$NPDeath.ER)) %>% 
  factor(levels = c("censor", "NPYesERPos", "NPYesERNeg"))

dat3$NPDeath2.PR <- case_when(dat3$NPDeath.PR %in% c("Dead", "Censored") ~ "censor",
                              TRUE ~ as.character(dat3$NPDeath.PR)) %>% 
  factor(levels = c("censor", "NPYesPRPos", "NPYesPRNeg"))

dat3$NPDeath2.HER2 <- case_when(dat3$NPDeath.HER2 %in% c("Dead", "Censored") ~ "censor",
                                TRUE ~ as.character(dat3$NPDeath.HER2)) %>% 
  factor(levels = c("censor", "NPYesHER2Pos", "NPYesHER2Neg"))
```


```{r order_variable, eval=FALSE}
#################################################################
##                        Order columns                        ##
#################################################################
dat3 <- dat3 %>%
  select("Subject.ID",
         
         #################################################################
         ##                   Demographical variables                   ##
         #################################################################
         "Age.at.Diagnosis", "Race.Ethnicity2", "Race.Ethnicity3", "Race.Ethnicity",    
         "Race.Ethnicity",
         
         ##################################################################
         ##                   Disease history variables                  ##
         ##################################################################
         "Clinical.T.Stage", "Clinical.T.Stage2", 
         "Clinical.N.Stage", "Clinical.N.Stage2", 
         "Date.of.Diagnosis", "Index.Tumor.Status", 
         "Past.Ipsilateral.Br.CA", "Past.Contralateral.Br.CA", ## Past Ipsilateral Breast Cancer 
         "Tumor.Size.best.estimate.By.Path.Primary.surg.case",
         "Tumor.Size.best.estimate.By.Breast.Imaging.NACT.case",
         "Needle.biopsy.proven.nodal.metastases.at.Dx",
         "Histology", "Any.high.grade.Disease", "Any.LVI", "Ki67",
         ## LVI: lymphovascular invasion
         
         #################################################################
         ##           Screening/diagnosis/treatment variables           ##
         #################################################################
         "Mammo.Screen.Detected", "Mammo.Occult", "MRI.Screen.Detected",
         "Date.of.Diagnosis",
         "First.Treatment.Modality", "Date.First.Treatment.Delivered",               
         "Any.Attempt.at.Lumpectomy", "Mastectomy.Surgery", "CPM", ## Contralateral Prophylactic Mastectomy
         "Any.SLN.Biopsy", "ALND", "If.Primary.Surgery.Date.of.First.Surgery", ## Sentinel Lymph Node; Axillary Lymph Node Dissection
         "If.primary.surgery.Date.of.Last.Surgery", 
         "If.Primary.Surgery.pT.Stage", "If.Primary.Surgery.pN.Stage",                   "Neoadjuvant.Chemotherapy",
         "In.NACT.did.pt.complete.all.planned.preop.CTX",                
         "If.NACT.date.CTX.initiated",                                   
         "If.NACT.CTX.components.check.all.delivered.choice.A",       
         "If.NACT.CTX.components.check.all.delivered.choice.T",          
         "If.NACT.CTX.components.check.all.delivered.choice.C",       
         "If.NACT.preop.Herceptin", "If.NACT.preop.Perjeta",
         "If.NACT.ypT.Stage", "If.NACT.ypN.Stage", 
         "if.NACT.pCR", "If.NACT.postop.Capecitabine",
         "If.NACT.postop.Kadcyla.TDM.1", "Postop.Adjuvant.CTX",
         "If.Postop.Adjuvant.CTX.did.pt.complete.all.planned.postop.CTX",
         "If.Postop.Adjuvant.CTX.date.CTX.initiated",                    
         "Postop.Adjuvant.XRT", 
         "If.postop.XRT.date.XRT.initiated", "If.postop.XRT.date.XRT.initiated",
         "Genetic.Testing.Done", "Genetic.Testing.Result.s",
         
          #################################################################
          ##                      Outcome variables                      ##
          #################################################################
         "Local.Recurrence", "Distant.Recurrence", "New.Breast.Primary", 
         "ER.LR", "PR.LR", "HER2.LR", "ER.NP", "PR.NP", "HER2.NP", 
         "T2LR", "T2DR", "T2NP", "T2Death", "T2LFU",
         "LRFS.event", "DRFS.event", "NPFS.event",
         "LRFS.time", "DRFS.time", "NPFS.time",
         "NP5y", "DR5y", "LR5y", 
         "Death", "LRDeath", "DRDeath", "NPDeath",
         "T2LRDeath", "T2DRDeath", "T2NPDeath",                                          
         "LRDeath.ER", "LRDeath.PR", "LRDeath.HER2", 
         "T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2",
         "NPDeath.ER", "NPDeath.PR", "NPDeath.HER2",
         "T2NPDeath.ER", "T2NPDeath.PR", "T2NPDeath.HER2",
         "Any.Local.Recurrence", "Date.Local.Recurrence", 
         "Any.Distant.Recurrence", "Site.First.Distant.Recurrence",
         "Date.First.Distant.Recurrence", "Any.New.subsequent.Br.1",
         "Date.New.Breast.primary", "Date.Death", "Date.Last.Follow.up",
         "Status.Last.Follow.up", everything()
         )
```


```{r save_data, eval=FALSE}
#################################################################
##                          Save data                          ##
#################################################################
date.analysis <- format(Sys.Date(), "%Y%b%d")
dput(dat0, paste0("../data/derived/", date.analysis, "_dat0.Rdata"))
dput(dat1, paste0("../data/derived/", date.analysis, "_dat1.Rdata"))
dput(dat2, paste0("../data/derived/", date.analysis, "_dat2.Rdata"))
dput(dat3, paste0("../data/derived/", date.analysis, "_dat3.Rdata"))
dput(dat3, paste0("../data/derived/", date.analysis, "_dat_TNBC.Rdata"))
write.csv(dat3, paste0("../data/derived/", date.analysis, "_dat_TNBC.csv"), row.names = F)
```


```{r load_cleaned_data}
##################################################################
##                  Load cleaned data in Rdata                  ##
##################################################################
dat.work <- dget("../data/derived/2022Dec21_dat_TNBC.Rdata")
```


```{r, eval=FALSE, include=FALSE}
#################################################################
##       Estimate the missing distribution of recurrence       ##
#################################################################
mis.cal <- function(var1, var2) {
  siz.rec <- length(which(dat.work[var1] == "Yes"))
  mis.date.rec <- length(which(dat.work[var1] == "Yes" & is.na(dat.work[var2])))
  return(list = c(siz.rec, mis.date.rec))
}
mis.cal(var1 = "Local.Recurrence", var2 = "Date.Local.Recurrence")
mis.cal(var1 = "Distant.Recurrence", var2 = "Date.First.Distant.Recurrence")
mis.cal(var1 = "New.Breast.Primary", var2 = "Date.New.Breast.primary")
```

```{r, results="hide"}
#################################################################
##                     Set study variables                     ##
#################################################################
vars.all <- c(
  
  ###  Demographical variables   
  "Age.at.Diagnosis", 
  "Race.Ethnicity2", "Race.Ethnicity3", 
  
  ###  Disease history variables  
  "Clinical.T.Stage", "Clinical.T.Stage2", "Clinical.N.Stage", "Clinical.N.Stage2", 
  "Index.Tumor.Status",
  "Past.Ipsilateral.Br.CA", "Past.Contralateral.Br.CA",
  # "Tumor.Size.best.estimate.By.Path.Primary.surg.case",
  # "Tumor.Size.best.estimate.By.Breast.Imaging.NACT.case",
  "Needle.biopsy.proven.nodal.metastases.at.Dx",
  "Histology", "Any.high.grade.Disease", "Any.LVI", "Ki67",
  # "ER.expression2",
  # "PR.expression2",
  # "HER2.neu.IHC",
  # "HER2.neu.FISH",
  
  ###  Screening/diagnosis/treatment variables
  "Mammo.Screen.Detected", "Mammo.Occult", "MRI.Screen.Detected", # Screen
  "First.Treatment.Modality", "Any.Attempt.at.Lumpectomy", "Mastectomy.Surgery",
  "CPM", "Any.SLN.Biopsy", "ALND",
  "If.Primary.Surgery.pT.Stage", "If.Primary.Surgery.pN.Stage",
  "Neoadjuvant.Chemotherapy",
  "In.NACT.did.pt.complete.all.planned.preop.CTX",
  "If.NACT.CTX.components.check.all.delivered.choice.A",
  "If.NACT.CTX.components.check.all.delivered.choice.T",
  "If.NACT.CTX.components.check.all.delivered.choice.C",
  "If.NACT.preop.Herceptin", "If.NACT.preop.Perjeta",
  "If.NACT.ypT.Stage", "If.NACT.ypN.Stage", "if.NACT.pCR",
  "If.NACT.postop.Capecitabine", "If.NACT.postop.Kadcyla.TDM.1",
  "Postop.Adjuvant.CTX",
  "If.Postop.Adjuvant.CTX.did.pt.complete.all.planned.postop.CTX",
  "Postop.Adjuvant.XRT",
  "Genetic.Testing.Done", "Genetic.Testing.Result.s",
  
  ###  Outcome variables
  "Local.Recurrence", "Distant.Recurrence", "New.Breast.Primary", # Outcome variables
  "ER.LR", "PR.LR", "HER2.LR", "ER.NP", "PR.NP", "HER2.NP", # ER/PR/HER2
  "T2LR", "T2DR", "T2NP", "T2Death", "T2LFU", # Survival time
  "LRFS.event", "DRFS.event", "NPFS.event", 
  "LRFS.time", "DRFS.time", "NPFS.time", 
  "NP5y", "DR5y", "LR5y", # Survival event
  "LRDeath.ER", "LRDeath.PR", "LRDeath.HER2", # Survival event
  "T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2", # Survival time
  "Status.Last.Follow.up"
)

# Create an indicator [0, 1] for all categorical variables 
vars.cat <- rep(1, length(vars.all))
vars.cat[vars.all %in% c("Age.at.Diagnosis", "T2LR", "T2DR", "T2NP", "T2Death", 
                         "T2LFU", "LRFS.time", "DRFS.time", "NPFS.time",
                         "T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2")] <- 0

# Create an index for the particular categorical variable to drop
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity2"))
```

## Summary of patients characteristics by Race.Ethnicity2

```{r, results="hide"}
# Create an index for the particular categorical variable to drop
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity2"))

# Create a summary table by Race.Ethnicity2
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "Race.Ethnicity2")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Race/Ethnicity (exclude Race.Ethnicity2 = Other)

```{r, results="hide"}
# Exclude observations with the other race/ethnicity
dat.work2 <- dat.work[dat.work$Race.Ethnicity2 != "Other", ]

# Create a summary table by Race.Ethnicity2
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity2", 
                                     "Race.Ethnicity3", 
                                     "Ki67", 
                                     "Genetic.Testing.Result.s"))
out <- fsmry.dmgrph(dat = dat.work2,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "Race.Ethnicity2")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Race.Ethnicity3 (WA vs all other races combined)

```{r, results="hide"}
# Create a summary table by Race.Ethnicity3
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity3",
                                     "Ki67",
                                     "Genetic.Testing.Result.s"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "Race.Ethnicity3")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Local.Recurrence

Note that the p-values in the following table should not be used for assessing association between each of the variables and recurrence as the analysis did not take into account different follow-up times.

```{r, results="hide"}
# Create a summary table by Local.Recurrence
vars.cat.rm <- which(vars.all %in% c("Local.Recurrence",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "ER.NP",
                                     "PR.NP",
                                     "HER2.NP"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "Local.Recurrence")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Distant.Recurrence

Note that the p-values in the following table should not be used for assessing association between each of the variables and recurrence as the analysis did not take into account different follow-up times.

```{r, results="hide"}
# Create a summary table by Distant.Recurrence
# table(dat.work$Distant.Recurrence, useNA = "ifany")
vars.cat.rm <- which(vars.all %in% c("Distant.Recurrence",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "ER.LR",
                                     "PR.LR",
                                     "HER2.LR",
                                     "ER.NP",
                                     "PR.NP",
                                     "HER2.NP"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "Distant.Recurrence")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by New.Breast.Primary

Note that the p-values in the following table should not be used for assessing association between each of the variables and recurrence as the analysis did not take into account different follow-up times.

```{r, results="hide"}
# Create a summary table by New.Breast.Primary
vars.cat.rm <- which(vars.all %in% c("New.Breast.Primary",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "ER.LR",
                                     "PR.LR",
                                     "HER2.LR"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "New.Breast.Primary")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by 5-year local recurrence (column proportion)

```{r, results="hide"}
# Create a summary table by 5-year local recurrence
id.keep <- which(!is.na(dat.work$LR5y))
vars.cat.rm <- which(vars.all %in% c("LR5y", 
                                     "Local.Recurrence", 
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "If.NACT.preop.Perjeta", 
                                     "If.NACT.postop.Kadcyla.TDM.1",
                                     "HER2.NP" # 'x' must have at least 2 rows and columns
))

out <- fsmry.dmgrph(dat = dat.work[id.keep, ],
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "LR5y")

##################################################################
##                  Problem: only one category                  ##
##################################################################
# Error in fisher.test(y.by.grp, simulate.p.value = T) : 
#   'x' must have at least 2 rows and columns
# Called from: fisher.test(y.by.grp, simulate.p.value = T)
# Browse[1]> 
# table(dat.work[id.keep, ]$If.NACT.preop.Perjeta, useNA = "ifany")
# 
#   No <NA> 
#   22  181 
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by 5-year local recurrence (row proportion)
```{r, results="hide"}
source("../BTKR_function/fsmry.dmgrph.rowprop.R")
out <- fsmry.dmgrph.rowprop(dat = dat.work[id.keep, ],
                            vars = vars.all[-vars.cat.rm],
                            vars.cat = vars.cat[-vars.cat.rm],
                            by = "LR5y")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

### Additional results for each categorical variable

```{r, results="asis"}
#################################################################
##                   Set possible predictors                   ##
#################################################################
vars.ana.rm <- c("Age.at.Diagnosis", 
                 "Local.Recurrence", "Distant.Recurrence", "New.Breast.Primary",
                 "Ki67",
                 "If.NACT.postop.Kadcyla.TDM.1", # Only one category
                 "Genetic.Testing.Done",
                 "Genetic.Testing.Result.s",
                 "Status.Last.Follow.up",
                 "ER.NP", "PR.NP", "HER2.NP", # ER/PR/HER2 for new breast primary
                 "T2LR", "T2DR", "T2NP", "T2Death", "T2LFU",
                 "LRFS.event", "DRFS.event", "NPFS.event",
                 "LRFS.time", "DRFS.time", "NPFS.time",
                 "NP5y", "DR5y", "LR5y",
                 "LRDeath.ER", "LRDeath.PR", "LRDeath.HER2",
                 "T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2"
                 )
  
vars.ana <- vars.all[vars.all %in% vars.ana.rm == FALSE]

id.keep <- which(!is.na(dat.work$LR5y))
for (i in 1:length(vars.ana)) {
  
  out.i <-
    fsmry2.by.grp(y = dat.work$LR5y[id.keep],
                  grp = dat.work[id.keep, vars.ana[i]],
                  cmp.method = "fisher")
  
  cat(paste0("\n#### 5-year Local Recurrence ~ ", vars.ana[[i]], "\n"))
  
  if (class(out.i) == "list") {
    
    cat(paste0("\nSummary", "\n"))
    
    print(knitr::kable(out.i[[1]]))
    
    cat(paste0("\nMissingness", "\n"))
    
    print(knitr::kable(out.i[[2]]))
  } else
    
    print(knitr::kable(out.i))
  
  cat("\n")
}
```

## Summary of patients characteristics by 5-year distant recurrence (column proportion)

```{r, results="hide"}
# Create a summary table by 5-year distant recurrence
id.keep <- which(!is.na(dat.work$DR5y))
vars.cat.rm <- which(vars.all %in% c("DR5y", 
                                     "Distant.Recurrence",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "If.NACT.postop.Kadcyla.TDM.1",
                                     "HER2.NP" # 'x' must have at least 2 rows and columns
))

out <- fsmry.dmgrph(dat = dat.work[id.keep, ],
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "DR5y")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by 5-year distant recurrence (row proportion)
```{r, results="hide"}
out <- fsmry.dmgrph.rowprop(dat = dat.work[id.keep, ],
                            vars = vars.all[-vars.cat.rm],
                            vars.cat = vars.cat[-vars.cat.rm],
                            by = "DR5y")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

### Additional results for each categorical variable

```{r, results="asis"}
vars.ana.rm <- c("Age.at.Diagnosis", 
                 "Local.Recurrence", "Distant.Recurrence", "New.Breast.Primary",
                 "Ki67",
                 "If.NACT.postop.Kadcyla.TDM.1", # Only one category
                 "Genetic.Testing.Done",
                 "Genetic.Testing.Result.s",
                 "Status.Last.Follow.up",
                 "ER.LR", "PR.LR", "HER2.LR",
                 "ER.NP", "PR.NP", "HER2.NP",
                 "T2LR", "T2DR", "T2NP", "T2Death", "T2LFU",
                 "LRFS.event", "DRFS.event", "NPFS.event",
                 "LRFS.time", "DRFS.time", "NPFS.time",
                 "NP5y", "DR5y", "LR5y",
                 "LRDeath.ER", "LRDeath.PR", "LRDeath.HER2",
                 "T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2"
                 )
vars.ana <- vars.all[vars.all %in% vars.ana.rm == FALSE]

id.keep <- which(!is.na(dat.work$DR5y))
for (i in 1:length(vars.ana)) {
  
  out.i <-
    fsmry2.by.grp(y = dat.work$DR5y[id.keep],
                  grp = dat.work[id.keep, vars.ana[i]],
                  cmp.method = "fisher")
  
  cat(paste0("\n#### 5-year Distant Recurrence ~ ", vars.ana[[i]], "\n"))
  
  if (class(out.i) == "list") {
    
    cat(paste0("\nSummary", "\n"))
    
    print(knitr::kable(out.i[[1]]))
    
    cat(paste0("\nMissingness", "\n"))
    
    print(knitr::kable(out.i[[2]]))
  } else
    
    print(knitr::kable(out.i))
  
  cat("\n")
}
```

## Summary of patients characteristics by 5-year new primary breast cancer (column proportion)

```{r, results="hide"}
# Create a summary table by 5-year new breast primary recurrence.
id.keep <- which(!is.na(dat.work$NP5y))
vars.cat.rm <- which(vars.all %in% c("NP5y", 
                                     "New.Breast.Primary",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "If.NACT.postop.Kadcyla.TDM.1")) 

out <- fsmry.dmgrph(dat = dat.work[id.keep, ],
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = "NP5y")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by 5-year new primary breast cancer (row proportion)

```{r, results="hide"}
out <- fsmry.dmgrph.rowprop(dat = dat.work[id.keep, ],
                            vars = vars.all[-vars.cat.rm],
                            vars.cat = vars.cat[-vars.cat.rm],
                            by = "NP5y")
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

### Additional results for each categorical variable

```{r, results="asis"}
vars.ana.rm <- c("Age.at.Diagnosis", 
                 "Local.Recurrence", "Distant.Recurrence", "New.Breast.Primary",
                 "Ki67",
                 "If.NACT.postop.Kadcyla.TDM.1", # Only one category
                 "Genetic.Testing.Done",
                 "Genetic.Testing.Result.s",
                 "Status.Last.Follow.up",
                 "ER.LR", "PR.LR", "HER2.LR", # ER/PR/HER2 for local recurrence
                 "T2LR", "T2DR", "T2NP", "T2Death", "T2LFU",
                 "LRFS.event", "DRFS.event", "NPFS.event",
                 "LRFS.time", "DRFS.time", "NPFS.time",
                 "NP5y", "DR5y", "LR5y",
                 "LRDeath.ER", "LRDeath.PR", "LRDeath.HER2",
                 "T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2")

vars.ana <- vars.all[vars.all %in% vars.ana.rm == FALSE]

id.keep <- which(!is.na(dat.work$NP5y))
for (i in 1:length(vars.ana)) {
  
  out.i <-
    fsmry2.by.grp(y = dat.work$NP5y[id.keep],
                  grp = dat.work[id.keep, vars.ana[i]],
                  cmp.method = "fisher")
  
  cat(paste0("\n#### 5-year New breast Primary Recurrence ~ ", vars.ana[[i]], "\n"))
  
  if (class(out.i) == "list") {
    
    cat(paste0("\nSummary", "\n"))
    
    print(knitr::kable(out.i[[1]]))
    
    cat(paste0("\nMissingness", "\n"))
    
    print(knitr::kable(out.i[[2]]))
  } else
    
    print(knitr::kable(out.i))
  
  cat("\n")
}
```

## Incidence rate of breast cancer recurrence and new breast cancer

```{r km_analysis_nomarker, results='hide'}
##################################################################
##             Estimate the incidence rate of LR/NP             ##
##################################################################
var.time <- c("T2LRDeath", "T2DRDeath", "T2NPDeath")
var.event <- c("LRDeath2", "DRDeath2", "NPDeath2")

out.i <- mclapply(1:3,
  function(i){ 
    fit.i <- survfit(formula(paste0("Surv(", var.time[i], ", ", var.event[i], ") ~ 1")), data = dat.work) # Combine death and censored
    res.i <- summary(fit.i, times = c(365.25, 365.25*2, 365.25*3, 365.25*5, 365.25*10)) 
    out.i <- data.frame(time = res.i$time, 
                        n.risk = res.i$n.risk[, 1], 
                        estimate = 1 - res.i$pstate[, 1], 
                        std.error = res.i$std.err[, 1], 
                        conf.low = 1 - res.i$upper[, 1], 
                        conf.high = 1 - res.i$lower[, 1]) %>% 
      mutate(across(.cols = c(estimate, std.error, conf.low, conf.high), num, digits = 4))
    return(list(fit = fit.i, res = res.i, out = out.i))},
  mc.cores = 4L)
```


```{r competing_risk_analysis_marker, results='hide'}
###################################################################
##  Estimate and plot the incidence rate of LR/NP by ER/PR/HER2  ##
###################################################################
var.time.LR <- c("T2LRDeath.ER", "T2LRDeath.PR", "T2LRDeath.HER2")
var.event.LR <- c("LRDeath2.ER", "LRDeath2.PR", "LRDeath2.HER2")
var.time.NP <- c("T2NPDeath.ER", "T2NPDeath.PR", "T2NPDeath.HER2")
var.event.NP <- c("NPDeath2.ER", "NPDeath2.PR", "NPDeath2.HER2")
var.time2 <- c(var.time.LR, var.time.NP)

## Check the distributions of each survival time (T2LRDeath.ER, T2LRDeath.PR, T2LRDeath.HER2, T2NPDeath.ER, T2NPDeath.PR, T2NPDeath.HER2)
# mclapply(1:6, 
#          function(i){summary(dat.work[var.time2[i]])},
#          mc.cores = 4L)

# Create a new outcome showing that the recurrence with positive marker value and recurrence with negative marker values are competing outcomes as well. 

out.i.LR <- mclapply(1:3,
  function(i){ 
    est.i.LR <- cuminc(
      formula(paste0("Surv(", var.time.LR[i], ", ", var.event.LR[i], ") ~ 1")), 
      data = dat.work, conf.level = 0.95)
    est.i.LR.timepoint <- est.i.LR %>% 
      tidy(time = c(365.25, 365.25*2, 365.25*3, 365.25*5, 365.25*10)) %>% 
      mutate(across(.cols = c(estimate, std.error, conf.low, conf.high), num, digits = 4))
    plot.i.LR <- ggcuminc(x = est.i.LR, 
                          outcome = names(table(dat.work[[var.event.LR[i]]]))[-1],
                          color = c("#A73030FF"),
                          theme = list(ggplot2::theme_classic(), 
                                       ggplot2::theme(legend.position = "bottom"),
                                       ggplot2::theme(strip.background = ggplot2::element_blank()),
                                       ggplot2::theme(axis.text = ggplot2::element_text(size = 10)),
                                       ggplot2::theme(axis.title = ggplot2::element_text(size = 12)),
                                       ggplot2::theme(legend.text = ggplot2::element_text(size = 10))
                                       )
                          ) +
                   add_confidence_interval() +
                   add_risktable() 
    return(list(est = est.i.LR, est.timepoint = est.i.LR.timepoint, curve = plot.i.LR)) 
    },
  mc.cores = 4L)

out.i.NP <- mclapply(1:3,
  function(i){ 
    est.i.NP <- cuminc(
      formula(paste0("Surv(", var.time.NP[i], ", ", var.event.NP[i], ") ~ 1")), 
      data = dat.work, conf.level = 0.95)
    est.i.NP.timepoint <- est.i.NP %>% 
      tidy(time = c(365.25, 365.25*2, 365.25*3, 365.25*5, 365.25*10)) %>% 
      mutate(across(.cols = c(estimate, std.error, conf.low, conf.high), num, digits = 4))
    plot.i.NP <- ggcuminc(x = est.i.NP, 
                          outcome = names(table(dat.work[[var.event.NP[i]]]))[-1],
                          color = c("#A73030FF"),
                          theme = list(ggplot2::theme_classic(), 
                                       ggplot2::theme(legend.position = "bottom"),
                                       ggplot2::theme(strip.background = ggplot2::element_blank()),
                                       ggplot2::theme(axis.text = ggplot2::element_text(size = 10)),
                                       ggplot2::theme(axis.title = ggplot2::element_text(size = 12)),
                                       ggplot2::theme(legend.text = ggplot2::element_text(size = 10))
                                       )
                          ) +
                   add_confidence_interval() +
                   add_risktable() 
    return(list(est = est.i.NP, est.timepoint = est.i.NP.timepoint, curve = plot.i.NP)) 
    },
  mc.cores = 4L)
```

### Local recurrence

```{r}
knitr::kable(out.i[[1]][["out"]])
cat("\n")
plot(
  out.i[[1]][["fit"]], 
  fun = "event",
  xlab = "Days", 
  ylab = "1 - survival probability",
  main = "Event rate curve of LR")
```

### Local recurrence with ER marker values

```{r}
knitr::kable(out.i.LR[[1]][["est.timepoint"]])
# Return same results of the following codes
# i = 1
# cmprsk::cuminc(
#     ftime = dat.work[var.time.LR[i]] %>% pull(), 
#     fstatus = dat.work[var.event.LR[i]] %>% pull(),
#     cencode = "censor") %>% cmprsk::timepoints(times = c(365.25, 365.25*2, 365.25*3, 365.25*5, 365.25*10))
cat("\n")
out.i.LR[[1]][["curve"]]
```

### Local recurrence with PR marker values

```{r}
knitr::kable(out.i.LR[[2]][["est.timepoint"]])
cat("\n")
out.i.LR[[2]][["curve"]]
```

### Local recurrence with HER2 marker values

```{r}
knitr::kable(out.i.LR[[3]][["est.timepoint"]])
cat("\n")
out.i.LR[[3]][["curve"]]
```

### Distant recurrence

```{r}
knitr::kable(out.i[[2]][["out"]])
cat("\n")
plot(
  out.i[[2]][["fit"]], 
  fun = "event",
  xlab = "Days", 
  ylab = "1 - survival probability",
  main = "Event rate curve of DR")
```

### New primary breast cancer

```{r}
knitr::kable(out.i[[3]][["out"]])
cat("\n")
plot(
  out.i[[3]][["fit"]], 
  fun = "event",
  xlab = "Days", 
  ylab = "1 - survival probability",
  main = "Event rate curve of DR")
```

### New primary breast cancer with ER marker values

```{r}
knitr::kable(out.i.NP[[1]][["est.timepoint"]])
cat("\n")
out.i.NP[[1]][["curve"]]
```

### New primary breast cancer with PR marker values

```{r}
knitr::kable(out.i.NP[[2]][["est.timepoint"]])
cat("\n")
out.i.NP[[2]][["curve"]]
```

### New primary breast cancer with HER2 marker values

```{r}
knitr::kable(out.i.NP[[3]][["est.timepoint"]])
cat("\n")
out.i.NP[[3]][["curve"]]
```

# Session info

```{r}
sessionInfo()
```


```{r analysis_plan_future, include=FALSE}
##################################################################
##                     Future analysis plan                     ##
##################################################################
## Design the R- and Python-based machine learning pipeline that predicts the 5-year recurrence and new cancer in TNBC patients using the 604 observations of this TNBC project
```


```{r data_preprocess}
library(tidyverse)
dat_py <- dget("../data/derived/2022Dec21_dat3.Rdata")
vars_all <- c(
  ###  Demographical variables   
  "Age.at.Diagnosis",  "Race.Ethnicity2",
  
  ###  Disease history variables  
  "Clinical.T.Stage2", "Clinical.N.Stage2", 
  "Past.Ipsilateral.Br.CA", "Past.Contralateral.Br.CA",
  "Needle.biopsy.proven.nodal.metastases.at.Dx",
  "Histology", "Any.high.grade.Disease", "Any.LVI", "Ki67",

  ###  Screening/diagnosis/treatment variables
  "Mammo.Screen.Detected", "Mammo.Occult", "MRI.Screen.Detected", 
  "First.Treatment.Modality", "Any.Attempt.at.Lumpectomy", "Mastectomy.Surgery",
  "CPM", "Any.SLN.Biopsy", "ALND", "Neoadjuvant.Chemotherapy",
  
  ###  Outcome variables
  "NP5y", "DR5y", "LR5y" # Survival event
)
dat_py <- dat_py[names(dat_py) %in% vars_all]

# Convert all character columns into factor columns
dat_py <- dat_py %>% 
  mutate_if(is.character, as.factor)

# str(dat_py)
```


```{r attach_reticulate}
library(reticulate)
# py_config() 
use_python("/Users/anniliu/mambaforge/bin/python")
# use_condaenv(condaenv = "base", conda = "auto", required = NULL)
# quit # quit the Python interface in RMarkdown
```


```{r open_iTerm2}
# conda activate base
# conda list
# conda install scikit-learn
```


```{python}
# Import necessary libraries
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
import pandas as pd
```


```{python}
# Load the data
dat = pd.DataFrame(r.dat_py)

# Split the data into features and target
X = dat.drop(['LR5y', 'DR5y', 'NP5y'], axis=1)
y = dat['LR5y']

# Split the data into training and test sets
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=999)

# Train the model
model = RandomForestClassifier()
model.fit(X_train, y_train)

# Make predictions on the test set
predictions = model.predict(X_test)

# Evaluate the model's performance
accuracy = model.score(X_test, y_test)
print('Accuracy:', accuracy)
```
