---
title: "Oncotype Project"
author: "Anni Liu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
knit: knitautomator::knit_filename
output:
  word_document:
    fig_caption: no
    fig_height: 4
    fig_width: 4
    highlight: null
    toc: yes
    reference_docx: manuscript_style_V0.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  options(scipen = 999, digits = 4),
  cache = TRUE,
  error = FALSE,
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE,
  fig.width = 12,
  fig.height = 8
)
```

# Data preparations
```{r include=FALSE}
## Attach libraries and functions
easypackages::libraries("tidyverse", "readxl", "gtsummary", "flextable", "stringi", "fst", "broom", "labelled", "data.table", "BTKR") |> suppressPackageStartupMessages()
"%_%" <- function(m, n) paste0(m, "_", n)
"%0%" <- function(m, n) paste0(m, n)

piece.table.wrapper <- function (y, grp, dat, transpose = F, method = "fisher") {
  if (transpose == T) {
    y.f <- grp
    grp.f <- y
  } else {
    y.f <- y
    grp.f <- grp
  }
  dat <- get(dat)
  out.i <- BTKR::fsmry2.by.grp(y = dat[, y.f], 
                               grp = dat[, grp.f], 
                               cmp.method = method)
    
  cat("\n#### " %0% y.f %0% " ~ " %0% grp.f %0% "\n")
    
  if (class(out.i) == "list") {
    cat("\nSummary" %0% "\n")
    print(knitr::kable(out.i[[1]]))
    cat("\nMissingness" %0% "\n")
    print(knitr::kable(out.i[[2]]))
  } else {
    print(knitr::kable(out.i)) 
  }
}
```

```{r check_cleaned_data, include=FALSE}
data_full <- read_fst(path = "../data/derived/2023Jul20_data_oncotype.RData")
```

```{r eval=FALSE, include=FALSE}
##------Load raw oncotype dataset------
data_full <- read_xlsx("../data/raw/Oncotype database WCM 2010-2023 for the statistician.xlsx", 
                       sheet = "Sheet1", 
                       range = c("A1:AD1452"), 
                       col_names = T,
                       na = c("Unknown", "", "NA", "Not applicable ", "Not applicable", "Not aplicable", "n/a", "N/a", "Unknown grade (not reported or unavailable)", "Unknown (not reported or unavailable)"))

##------Format variable names into the unified style (e.g., Patient ID -> Patient.id; Race/Ethnicity -> Race.ethnicity)------
temp_name <- names(data_full)
temp_name <- sapply(strsplit(temp_name, split = "\\-|\\s|\\(|\\)|\\/|\\%|^the$"), function(x) paste(x[!x %in% c("", "-", "(", ")", "/", "%", "the")], collapse = ".")) # \\s means the literal space 
temp_name <- gsub("$", ".", temp_name) # Chemotherapy without any comma [differ from Patient.ID]
temp_name <- sub("\\..*", ".", temp_name) %0% tolower(substring(temp_name, regexpr("*.\\.", temp_name) + 2))
temp_name <- gsub(".$", "", temp_name)
names(data_full) <- temp_name

##------Check the structure and distribution of character variables------
all_char <- sapply(names(data_full)[sapply(data_full, is.character)], function(x) with(data_full, table(get(x), useNA = "ifany")))  
# View(all_char)

##------Recode variables------
data_full <- as.data.table(data_full)
data_full[,Patient.gender:=factor(Patient.gender, levels=c("Female", "Male"))]
data_full[,Race.ethnicity:=gsub("West Indian", "Mixed", Race.ethnicity)]
data_full[,Race.ethnicity:=factor(Race.ethnicity, levels=c("White", "African-American", "Asian", "Hispanic", "Mixed"))]
data_full[,Surgical.procedure:=factor(Procedure, levels=c("Lumpectomy", "Total mastectomy"))]
data_full[,Axila.procedure:=factor(Axila.procedure, levels=c("Sentinel LN biopsy", "Axillary LN dissection", "None"))]
data_full[,Chemotherapy:=factor(Chemotherapy, levels=c("No", "Yes"))]
data_full[,Endocrine.therapy:=factor(Endocrine.therapy, levels=c("Yes", "No"))]
data_full[,Radiation.therapy:=factor(Radiation.therapy, levels=c("Yes", "No"))]
# data_full[,Treatment.modality:=]
# iNZightTools::combineCatVars(.data = data_full, vars = c("Surgical.procedure", "Endocrine.therapy", "Radiation.therapy"), sep = "_") # Suitable for non-missing values

# Create a treatment modality variable that clearly reflects the combined category of Surgical.procedure, Endocrine.therapy, and Radiation.therapy
paste(data_full$Surgical.procedure, 
      paste0("Endo", data_full$Endocrine.therapy), 
      paste0("Rad", data_full$Radiation.therapy)) |> table(useNA = "ifany")
 #        Lumpectomy EndoNA RadNA         Lumpectomy EndoNA RadNo 
 #                             18                               4 
 #       Lumpectomy EndoNA RadYes         Lumpectomy EndoNo RadNA 
 #                             11                               1 
 #        Lumpectomy EndoNo RadNo        Lumpectomy EndoNo RadYes 
 #                             32                              48 
 #       Lumpectomy EndoYes RadNA        Lumpectomy EndoYes RadNo 
 #                              9                              41 
 #      Lumpectomy EndoYes RadYes                 NA EndoNA RadNA 
 #                            843                               1 
 #  Total mastectomy EndoNA RadNA   Total mastectomy EndoNA RadNo 
 #                              8                               6 
 # Total mastectomy EndoNA RadYes   Total mastectomy EndoNo RadNo 
 #                              1                              23 
 # Total mastectomy EndoNo RadYes  Total mastectomy EndoYes RadNA 
 #                              3                               1 
 # Total mastectomy EndoYes RadNo Total mastectomy EndoYes RadYes 
 #                            335                              66 

data_full[,Height:=Height.m]
data_full[,Weight:=Weight.at.diagnosis.kg]
data_full[,BMI:=Weight/(Height)^2]
# setdiff(which(is.na(data_full$BMI)), which(is.na(data_full$BMI.at.diagnosis)))
# data_full[Patient.id %in% c(406, 550, 787), c("Height", "Weight", "BMI.at.diagnosis", "BMI")]
#    Height Weight BMI.at.diagnosis BMI
# 1:     NA     NA             23.0  NA
# 2:     NA     NA             25.0  NA
# 3:     NA     NA             22.3  NA

data_full[,T.stage.2:=gsub("*.1.*", "T1", gsub("T3|T4", "T3|T4", Pathologic.t.stage)) |> factor(levels=c("T1", "T2", "T3|T4"))]
data_full[,N.stage.2:=ifelse(is.na(N.stage), NA, ifelse(N.stage %in% c(0, "0(i+)"), "N0", "N1|N2|N3")) |> factor(levels=c("N0", "N1|N2|N3"))]
data_full[,ER.status:=factor(ER.status, levels=c("Positive", "Negative"))]
data_full[,PR.status:=factor(PR.status, levels=c("Positive", "Negative"))]
data_full[,HER2.status:=factor(HER2.status, levels=c("Negative", "Equivocal", "Positive"))]
data_full[,Histological.type:=factor(Histological.type, levels=c("Invasive ductal carcinoma", "Invasive lobular carcinoma", "Mixed ductal and lobular"))]
data_full[,Histological.grade:=factor(Histological.grade, levels=c("Well differentiated", "Moderately differentiated", "Poorly differentiated"))]
data_full[,Histological.grade.2:=factor(Histological.grade, labels=c("Non-high grade", "Non-high grade", "High grade")) |> factor(levels=c("Non-high grade", "High grade"))]
data_full[,Lymphovascular.invasion:=factor(Lymphovascular.invasion, levels=c("No", "Yes"))]
data_full[,Local.recurrence:=factor(Local.recurrence.at.follow.up, levels=c("No", "Yes"))]
data_full[,Distant.metastasis:=factor(Distant.metastasis.at.follow.up, levels=c("No", "Yes"))]


##------Create survival analysis-related variables------
##------EVENT------
data_full[,Local.recurrence.2:=ifelse(Local.recurrence=="Yes",1,0)]
data_full[,Distant.metastasis.2:=ifelse(Distant.metastasis=="Yes",1,0)]
data_full[,Status:=ifelse(Alive.dead.status=="Alive", 0, 1)]

##------TIME------
data_full[,Time.to.follow.up:=as.numeric(as.Date(Date.of.last.follow.up)-as.Date(Date.of.diagnosis))]
data_full[,Time.to.follow.up.year:=Time.to.follow.up/365.25]
# summary(data_full$Time.to.follow.up.year)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.00    1.04    2.82    3.83    6.03   13.54 

# data_full[Local.recurrence=="Yes",Date.of.local.recurrence.if.applicable]
data_full[,Time.to.local.recurrence:=as.numeric(as.Date(Date.of.local.recurrence.if.applicable)-as.Date(Date.of.diagnosis))]
data_full[,Time.to.local.recurrence.year:=Time.to.local.recurrence/365.25]
# summary(data_full$Time.to.local.recurrence.year)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
# 0.3     1.7     2.3     3.6     4.1    12.7    1407 

# Date of death info is not available: not able to consider if time to death happens before time to last follow-up 
data_full[,Time.to.local.recurrence.or.follow.up:=ifelse(Local.recurrence=="Yes", Time.to.local.recurrence, Time.to.follow.up)]
data_full[,Time.to.local.recurrence.or.follow.up.year:=Time.to.local.recurrence.or.follow.up/365.25]
# summary(data_full$Time.to.local.recurrence.or.follow.up.year)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.00    1.03    2.78    3.76    5.83   13.54 

# data_full[Distant.metastasis=="Yes",Date.of.distant.metastasis]
data_full[,Time.to.distant.metastasis:=as.numeric(as.Date(Date.of.distant.metastasis)-as.Date(Date.of.diagnosis))]
data_full[,Time.to.distant.metastasis.year:=Time.to.distant.metastasis/365.25]
# summary(data_full$Time.to.distant.metastasis.year)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
# 0.5     2.1     3.7     4.4     6.4    10.1    1423 

data_full[,Time.to.distant.metastasis.or.follow.up:=ifelse(Distant.metastasis=="Yes", Time.to.distant.metastasis, Time.to.follow.up)]
data_full[,Time.to.distant.metastasis.or.follow.up.year:=Time.to.distant.metastasis.or.follow.up/365.25]
# summary(data_full$Time.to.distant.metastasis.or.follow.up.year)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.00    1.03    2.81    3.80    5.99   13.54 


##------Create logistic regression-related variables------
sample.size <- nrow(data_full)
data_full[,Local.recurrence.3year:=rep(0,sample.size)]
data_full[Local.recurrence=="Yes"][!is.na(Time.to.local.recurrence)][Time.to.local.recurrence.year<3]$Local.recurrence.3year <- 1
data_full[Local.recurrence=="No"][Time.to.follow.up.year<3]$Local.recurrence.3year <- NA
data_full[,Local.recurrence.3year.2:=ifelse(is.na(Local.recurrence.3year), NA, ifelse(Local.recurrence.3year == 1, "Yes", "No"))]

data_full[,Distant.metastasis.3year:=rep(0,sample.size)]
data_full[Distant.metastasis=="Yes"][!is.na(Time.to.distant.metastasis)][Time.to.distant.metastasis.year<3]$Distant.metastasis.3year <- 1
data_full[Distant.metastasis=="No"][Time.to.follow.up.year<3]$Distant.metastasis.3year <- NA
data_full[,Distant.metastasis.3year.2:=ifelse(is.na(Distant.metastasis.3year), NA, ifelse(Distant.metastasis.3year == 1, "Yes", "No"))]


##------Check the structure and distribution of new factor variables [! missing distribution]------
all_fac <- sapply(names(data_full)[sapply(data_full, is.factor)], function(x) with(data_full, table(get(x), useNA = "ifany")))
# View(all_fac)

all_fac_lev <- sapply(names(all_fac), function(x) with(data_full, levels(get(x))))
# View(all_fac_lev)
```

```{r save_cleaned_data, eval=FALSE, include=FALSE}
date.analysis <- format(Sys.Date(), "%Y%b%d")
write_fst(data_full, 
          path = paste0("../data/derived/", date.analysis, "_data_oncotype.RData"), 
          compress = 50, uniform_encoding = T)

write.csv(data_full, 
          file = paste0("../data/derived/", date.analysis, "_data_oncotype.csv"), 
          row.names = F)
```

```{r load_cleaned_data_again, include=FALSE}
data_full <- read_fst(path = "../data/derived/2023Jul20_data_oncotype.RData")
```


**Data dictionary**

* `Patient.gender`: gender with categories: Female (reference); Male
* `Age.at.diagnosis`: age at diagnosis (in years)
* `Race.ethnicity`: racial status with categories: White (reference); African-American; Asian; Hispanic; Mixed
* `BMI`: body mass index ($kg/m^2$)
* `Height`: height at diagnosis (in meters)
* `Weight`: weight at diagnosis (in kilograms)
* `Time.to.follow.up.year`: time to last follow-up (in years); calculated by subtracting date of diagnosis from date of last follow-up
* `Pathologic.t.stage`: T stage status with categories: T1A (reference); T1B; T1C; T2; T3; T4
* `T.stage.2`: tumor stage with categories: T1 (reference); T2; T3|T4
* `N.stage`: lymph node stage with original categories: 0 (reference); 0(i+); 1a; 1mi; 2a; 3
* `N.stage.2`: lymph node stage with categories: N0 (reference); N1|N2|N3
* `ER.status`: ER (Estrogen Receptor) status with categories: Positive (reference); Negative
* `PR.status`: PR (Progesterone Receptor) status with categories: Positive (reference); Negative
* `HER2.status`: HER2 (Human Epidermal Growth Factor Receptor 2) status with categories: Negative (reference); Equivocal; Positive
* `Oncotype.score`: oncotype score
* `Histological.type`: histological type with categories: Invasive ductal carcinoma (reference); Invasive lobular carcinoma; Mixed ductal and lobular
* `Histological.grade`: histological grade with categories: Well differentiated (reference); Moderately differentiated; Poorly differentiated
* `Histological.grade.2`: recategorized histological grade with categories: Non-high grade (reference); High grade
* `Tumor.size.cm`: tumor size (in cm)
* `Lymphovascular.invasion`: presence of lymphovascular invasion with categories: No (reference); Yes
* `Surgical.procedure`: surgical procedure with categories: Lumpectomy (reference); Total mastectomy
* `Axila.procedure`: axillary procedure with categories: Sentinel LN biopsy (reference); Axillary LN dissection; None
* `Chemotherapy`: chemotherapy treatment with categories: No (reference); Yes
* `Endocrine.therapy`: endocrine therapy with categories: Yes (reference); No
* `Radiation.therapy`: radiation therapy with categories: Yes (reference); No
* `Local.recurrence`: local recurrence with categories: No (reference); Yes
* `Distant.metastasis`: distant metastasis with categories: No (reference); Yes
* `Alive.dead.status`: patient status with categories: Alive (reference); Dead
* `Time.to.local.recurrence.year`: time to local recurrence (in years); calculated by subtracting date of diagnosis from date of local recurrence
* `Time.to.distant.metastasis.year`: time to distant metastasis (in years); calculated by subtracting date of diagnosis from date of distant metastasis
* `Local.recurrence.3year.2`: if a patient has the local recurrence within 3-year follow-up: No (reference); Yes
* `Distant.metastasis.3year.2`: if a patient has the distant metastasis within 3-year follow-up: No (reference); Yes


## Overall distributions of patient variables
```{r echo=FALSE, warning=FALSE}
var_focus <- c("Patient.gender", 
               "Age.at.diagnosis",
               "Race.ethnicity",
               "BMI",
               "Height",
               "Weight",
               "Time.to.follow.up.year",
               "Pathologic.t.stage",
               "T.stage.2",
               "N.stage",
               "N.stage.2",
               "ER.status",
               "PR.status",
               "HER2.status",
               "Oncotype.score",
               "Histological.type",
               "Histological.grade",
               "Histological.grade.2",
               "Tumor.size.cm",
               "Lymphovascular.invasion",
               "Surgical.procedure",
               "Axila.procedure",
               "Chemotherapy",
               "Endocrine.therapy",
               "Radiation.therapy",
               "Local.recurrence",
               "Distant.metastasis",
               "Alive.dead.status",
               "Time.to.local.recurrence.year",
               "Time.to.distant.metastasis.year",
               "Local.recurrence.3year.2",
               "Distant.metastasis.3year.2")

# var_label(data_full) <- list(
#   Patient.gender = "Sex",
#   Age.at.diagnosis = "Age at diagnosis (year)",
#   Race.ethnicity = "Race/ethnicity",
#   BMI = "Body mass index (kg/m2)",
#   Height = "Height (m)",
#   Weight = "Weight (kg)",
#   Time.to.follow.up.year = "Time to last follow-up (year)",
#   Pathologic.t.stage = "Original T stage",
#   T.stage.2 = "Recoded T stage",
#   N.stage = "Original N stage",
#   N.stage.2 = "Recoded N stage",
#   ER.status = "Estrogen receptor",
#   PR.status = "Progesterone receptor",
#   HER2.status = "Human epidermal growth factor receptor",
#   Oncotype.score = "Oncotype score",
#   Histological.type = "Histology type",
#   Histological.grade = "Original histology grade",
#   Histological.grade.2 = "Recoded histology grade",
#   Tumor.size.cm = "Tumor size (cm)",
#   Lymphovascular.invasion = "Lymphovascular invasion",
#   Surgical.procedure = "Surgical procedure",
#   Axila.procedure = "Axila procedure",
#   Endocrine.therapy = "Endocrine therapy",
#   Radiation.therapy = "Radiation therapy",
#   Local.recurrence = "Local recurrence",
#   Distant.metastasis = "Distant metastasis",
#   Time.to.local.recurrence.year = "Time to local recurrence (year)",
#   Time.to.distant.metastasis.year = "Time to distant metastasis (year)",
#   Local.recurrence.3year.2 = "3-year local recurrence",
#   Distant.metastasis.3year.2 = "3-year distant metastasis"
# )

# Create an indicator [0, 1] for all categorical variables 
var_cat <- rep(x = 1, times = length(var_focus))
var_cat[var_focus %in% names(data_full)[sapply(data_full, is.numeric)]] <- 0
```


```{r echo=FALSE, results="asis"}
out <- fsmry.dmgrph(dat = data_full,
                    vars = var_focus,
                    vars.cat = var_cat,
                    by = NULL)
```


```{r echo=FALSE, results="asis"}
knitr::kable(out[[1]], row.names = F)
```


## Overall distributions of patient variables in female patients
```{r echo=FALSE, results="asis"}
out <- fsmry.dmgrph(dat = data_full[data_full$Patient.gender == "Female", ],
                    vars = var_focus,
                    vars.cat = var_cat,
                    by = NULL)
```


```{r echo=FALSE, results="asis"}
knitr::kable(out[[1]], row.names = F)
```


```{r}
data_full$Patient.id[c(which(is.na(data_full$Surgical.procedure)), which(is.na(data_full$Endocrine.therapy)), which(is.na(data_full$Radiation.therapy))) |> unique()]
```


# Session information
```{r}
sessionInfo()
```
