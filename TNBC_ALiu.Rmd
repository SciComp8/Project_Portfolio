---
title: "TNBC Data Analysis"
author: "Anni Liu"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  word_document:
    fig_caption: no
    fig_height: 4
    fig_width: 4
    highlight: null
    toc: yes
params:
  date.analysis: !r format(Sys.Date(), "%Y%B%D")
  plot.fig: TRUE
  results.folder: FALSE
editor_options: 
  chunk_output_type: console
---

```{r analysis_plan_previous, include=FALSE}
#################################################################
##                    Previous analysis plan                   ##
#################################################################
##----------XKZ Comments start--------------------------------------------
## Variables to add:
## T2LR: time from Date.of.Diagnosis to date of local recurrence
## T2DR: time from Date.of.Diagnosis to date of distant recurrence
## T2NP: time from Date.of.Diagnosis to date of new primary
## T2Death: time from Date.of.Diagnosis to date of death
## T2LFU: time from Date.of.Diagnosis to date of last follow up
## LRFS.event: 1 if Local.Recurrence is Yes, 0 if No
## LRFS.time (local recurrence free survival time): T2LocRecur if had local recurrence, 
##    minimum of T2Death and T2LFU if no local recurrence
## DRFS.event: 1 if Distant.Recurrence is Yes, 0 if No
## DRFS.time (Distant recurrence free survival time): T2DisRecur if had distant recurrence, 
##    minimum of T2Death and T2LFU if no distant recurrence
## NPFS.event: 1 if New.Breast.Primary is Yes, 0 if No
## NPFS.time (New primary free survival time): T2NewPrim if had new Primary, 
##    minimum of T2Death and T2LFU if no new primary
## LR5y (5-year local recurrence):  Assign all to 0 first, 
##       change to 1 if had local recurrence and local recurrence occurred within 5 years of disease diagnosis, 
##       change to NA if no recurrence and time to last follow up since diagnosis less than 5 years  
## DR5y (5-year distant recurrence): defined in similar fashion as above
## NP5y (5-year new primary): defined in similar fashion as above
##----------------------xkz comments end----------------------------------------------------------
```


```{r analysis_plan_current, include=FALSE}
#################################################################
##                    Updated analysis plan                    ##
#################################################################
## Use the cumulative incidence function to estimate the incidence rate of local recurrence which treats death as the competing risk
### Add the following variables (lines starting from):

### Death: "Yes" if Date.Death has the value
###        "No" if Date.Death has NA

### LRDeath: NA if subjects are not at risk *
###          "LocRecur" if Local.Recurrence is Yes and Death is Yes or No
###          "Dead" if Death is Yes and Local.Recurrence is No
###          "Censored" if Local.Recurrence and Death are both No
### * NA:noT2LR:noT2D:noT2LFU 6
###   NA:noT2LR:noT2D:T2LFU 75
###   NA:noT2LR:T2D:T2LFU 5
###   No:noT2LR:noT2D:noT2LFU 12
###   Yes:noT2LR:noT2D:T2LFU 2
###   100 patients are not at risk  

### DRDeath: NA if subjects are not at risk * 
###          "DisRecur" if Distant.Recurrence is Yes and Death is Yes or No
###          "Dead" if Death is Yes and Distant.Recurrence is No
###          "Censored" if Distant.Recurrence and Death are both No
### * NA:noT2DR:noT2D:noT2LFU 6
###   NA:noT2DR:noT2D:T2LFU 69
###   NA:noT2DR:T2D:T2LFU 5  
###   No:noT2DR:noT2D:noT2LFU 11
###   Yes:noT2DR:noT2D:noT2LFU 1
###   Yes:noT2DR:noT2D:T2LFU 12
###   Yes:noT2DR:T2D:T2LFU 1
###   105 patients are not at risk

### NPDeath: NA if subjects are not at risk * 
###          "NBP" if New.Breast.Primary is Yes and Death is Yes or No
###          "Dead" if Death is Yes and New.Breast.Primary is No
###          "Censored" if New.Breast.Primary and Death are both No
### * NA:noT2NP:noT2D:noT2LFU 6
###   NA:noT2NP:noT2D:T2LFU 82
###   NA:noT2NP:T2D:T2LFU 6    
###   No:noT2NP:noT2D:noT2LFU 12
###   106 patients are not at risk

### T2LRDeath: NA if LRDeath is NA
###            `T2LR` if LRDeath is LocRecur
###            `T2Death` if LRDeath is Dead
###            `T2LFU` if LRDeath is Censored

### T2DRDeath: NA if DRDeath is NA
###            `T2DR` if DRDeath is DisRecur
###            `T2Death` if DRDeath is Dead
###            `T2LFU` if DRDeath is Censored

### T2NPDeath: NA if NPDeath is NA
###            `T2NP` if NPDeath is NBP
###            `T2Death` if NPDeath is Dead
###            `T2LFU` if NPDeath is Censored
```


```{r analysis_plan_future, include=FALSE}
##################################################################
##                     Future analysis plan                     ##
##################################################################
## Conceive the possibility of doing the machine learning survival analysis using the 604 observations of this TNBC project
```

# Data preparation

```{r shorcut, include=FALSE}
#################################################################
##                  RStudio keyboard shortcut                  ##
#################################################################
# Cursor at the beginning of a command line: Ctrl + A
# Cursor at the end of a command line: Ctrl + E
# Clear all the code from your console: Ctrl + L
# Create an assignment operator <-: Alt + - (Windows) or Option + - (Mac).
# Create a pipe operator %>%: Ctrl + Shift + M (Windows) or Cmd + Shift + M (Mac)
# Knit a document (knitr): Ctrl + Shift + K (Windows) or Cmd + Shift + K (Mac)
# Comment or uncomment current selection: Ctrl + Shift + C (Windows) or Cmd + Shift + C (Mac)
```


```{r include=FALSE, eval=FALSE}
system.time(
  list(range(dat3$T2Death, na.rm = TRUE), range(dat3$T2DR, na.rm = TRUE), range(dat3$T2NP, na.rm = TRUE), range(dat3$T2LFU, na.rm = TRUE))
)
   # user  system elapsed 
   #    0       0       0 

## If I simulate a large dataset...
dat.sim <- data.frame(a = 1:10e6, b = 1:10e6, c = 1:10e6)
system.time(
    list(range(dat.sim$a, na.rm = TRUE), range(dat.sim$b, na.rm = TRUE), range(dat.sim$c, na.rm = TRUE))
)
  #  user  system elapsed 
  # 0.403   0.025   0.428 

system.time(
  map(.x = list(dat.sim$a, dat.sim$b, dat.sim$c), 
      .f = range, 
      na.rm = T)
)
  #  user  system elapsed 
  # 0.389   0.023   0.412 

system.time(
  dat.sim.mat <- as.matrix(dat.sim) 
) 
  #  user  system elapsed 
  # 0.184   0.032   0.216 
system.time(
  apply(dat.sim.mat, 2, range)
)
  #  user  system elapsed 
  # 0.299   0.010   0.310 
# user time: 0.184 + 0.299 = 0.483

system.time(
  lapply(1:3, function(i){range(dat.sim[, i])})
)
  #  user  system elapsed 
  # 0.275   0.000   0.275 

library(parallel)
system.time(
  mclapply(1:3, 
           function(i){range(dat.sim[, i])},
           mc.cores = 4)
)
  #  user  system elapsed 
  # 0.002   0.008   0.128 
```


```{r global_options, include=FALSE}
#################################################################
##                       Parametrization                       ##
#################################################################
date.analysis <- params$date.analysis

if (params$plot.fig) {
  dir.fig <- paste0("figs_", date.analysis)
  if (!dir.exists(dir.fig)) # If the directory does not exist, we create a new directory use the name figs + current date stored in the object date.analysis; this object gets the value passed from the date.analysis from YAML params
    dir.create(dir.fig)
  knitr::opts_chunk$set(
    fig.width = 4,
    fig.height = 4,
    fig.path = dir.fig,
    dev = "png",
    dpi = 300,
    echo = FALSE,
    warning = FALSE,
    message = FALSE,
    cache = FALSE,
    comment = ""
  )
} else {
  knitr::opts_chunk$set(
    echo = FALSE,
    warning = FALSE,
    message = FALSE,
    cache = FALSE,
    comment = ""
  )
}

if (params$results.folder) {
  dir.result <- paste0("results_", date.analysis)
  if (!dir.exists(dir.result))
    dir.create(dir.result)
}

loc.perl <- "C:/cygwin64/bin/perl"
```


```{r include=FALSE}
##################################################################
##                        Load libraries                        ##
##################################################################
easypackages::libraries("BTKR", "multcomp", "readxl", "tidyverse", "bannerCommenter", "tidycmprsk", "parallel")
```


```{r}
##################################################################
##                    Load data for checking                    ##
##################################################################
dat0 <- dget("../data/derived/2022Nov23_dat0.Rdata")
dat1 <- dget("../data/derived/2022Nov23_dat1.Rdata")
dat2 <- dget("../data/derived/2022Nov23_dat2.Rdata")
dat3 <- dget("../data/derived/2022Nov23_dat3.Rdata")
dat.work <- dget("../data/derived/2022Nov23_dat_TNBC.Rdata")
```


```{r eval=FALSE}
##################################################################
##                          Clean data                          ##
##################################################################
dat0 <- read_xlsx(
  path = "../data/raw/TNBC WCM 1998-2018_Deidentified_Final_10_14_V2.xlsx",
  sheet = "TNBC no recurrence or new BC", 
  range = "A1:BL521",
  na = c("Unknown", "", "NA", "Not applicable ", "Not applicable", "Not aplicable", "n/a", "Unknown grade (not reported or unavailable)", "Unknown (not reported or unavailable)")) %>%
  select(-c("ER expression (%)", "PR expression (%)", "HER2/neu (IHC)", "HER2/neu (FISH)")) %>%
  mutate(ER.LR = "Negative",
         PR.LR = "Negative",
         HER2.LR = "Negative",
         ER.NP = "Negative",
         PR.NP = "Negative",
         HER2.NP = "Negative") %>%
  data.frame()

dat1 <- read_xlsx(
  path = "../data/raw/TNBC WCM 1998-2018_Deidentified_Final_10_14_V2.xlsx",
  sheet = "recurrence or new BC", 
  range = "A1:CE85",
  na = c("Unknown", "", "NA", "Not applicable ", "Not applicable", "Not aplicable", "n/a", "Unknown grade (not reported or unavailable)", "Unknown (not reported or unavailable)")) %>%
  data.frame()

var.rm <- c("Laterality.Primary", 
            "Laterality.local", 
            "Cancer.Type", 
            "ER.expression....",
            "PR.expression....",
            "HER2.neu..IHC.",
            "HER2.neu..FISH.",
            # "ER...60", # ER.LR
            "X....61", 
            # "PR...62", # PR.LR 
            "X....63", 
            # "HER2...64", # HER2.LR
            "IHC...65", 
            "FISH...66", 
            "Laterality.New", 
            "New.Path",
            # "ER...74", # ER.NP
            "X....75", 
            # "PR...76", # PR.NP
            "X....77", 
            # "HER2...78", # HER2.NP
            "IHC...79", 
            "FISH...80")

dat1 <- dat1 %>% 
  select(-var.rm) %>% 
  rename("Any.Local.Recurrence" = "Local.Recurrence",
         "ER.LR" = "ER...60",
         "PR.LR" = "PR...62",
         "HER2.LR" = "HER2...64",
         "ER.NP" = "ER...74",
         "PR.NP" = "PR...76",
         "HER2.NP" = "HER2...78") %>%
  select(everything(), 
         "Status.Last.Follow.up", 
         "Any.Local.Recurrence", 
         "Date.Local.Recurrence",
         "Any.Distant.Recurrence", 
         "Site.First.Distant.Recurrence", 
         "Date.First.Distant.Recurrence",
         "Any.New..subsequent..Br.1", 
         "Date.New.Breast.primary", 
         "Date.Death")

dat2 <- rbind(dat0, dat1)

##################################################################
##                       Fix column names                       ##
##################################################################
# If “.” matches any character, how do you match a literal “.”? You need to use an “escape” to tell the regular expression you want to match it exactly, not use its special behaviour. Like strings, regexps use the backslash, \, to escape special behaviour. So to match an ., you need the regexp \.. Unfortunately this creates a problem. We use strings to represent regular expressions, and \ is also used as an escape symbol in strings. So to create the regular expression \. we need the string "\\.".
# Step1: strsplit(names(dat2), split = "\\.")
# Step2: paste(x[x != ""], collapse = ".")
# Step3: sapply

names(dat2) <- 
  sapply(strsplit(names(dat2), split = "\\."), function(x)
    paste(x[x != ""], collapse = "."))
```

```{r eval=FALSE}
#################################################################
##                    Clean data (continue)                    ##
#################################################################
# table(dat.full$Race.Ethnicity2, useNA = "always")
dat3 <- dat2 %>%
  mutate(
    Race.Ethnicity2 = gsub(".*Asian.*|Filipino|Korean", "Asian",
                           gsub("Hisp.*", "Hisp/Latina", 
                                gsub("White|NHW|Arabic*", "WA",   #xkz: added NHW and arabic
                                     gsub("American.*|Pacific.*", "Other", Race.Ethnicity)))) %>%
    factor(levels = c("WA", "AA", "Asian", "Hisp/Latina", "Other"))) %>%
  mutate(
    Race.Ethnicity3 = ifelse(Race.Ethnicity2 == "WA", "WA", "Other") %>%
      factor(levels = c("WA", "Other"))) %>%
  mutate( # NA: 86
    Local.Recurrence = gsub("Never.*", NA, Any.Local.Recurrence) %>%  #xkz: "Never Disease Free" needs to be counted separately probably better as NA here
      factor()) %>% 
  mutate( # NA: 80
    Distant.Recurrence = gsub("Never.*", NA, Any.Distant.Recurrence) %>% 
      factor()) %>%
  mutate( # NA: 94
    New.Breast.Primary = Any.New.subsequent.Br.1 %>%
      factor()) %>% 
  mutate(
    Clinical.T.Stage2 = gsub("T1a|T1b|T1c|T2", "T1|T2",
                             gsub("T3|T4", "T3|T4", Clinical.T.Stage))) %>% 
  mutate(
    Clinical.N.Stage2 = gsub("N1|N2|N3", "N1|N2|N3", Clinical.N.Stage))


#################################################################
##        Recode T2LR/T2DR/T2NP/T2Death/T2LFU (in days)        ##
#################################################################
dat3 <- dat3 %>% 
  mutate( # LR: local recurrence
    T2LR = as.numeric(as.Date(Date.Local.Recurrence) - as.Date(Date.of.Diagnosis))) %>%
  mutate( # DR: distant recurrence
    T2DR = as.numeric(as.Date(Date.First.Distant.Recurrence) - as.Date(Date.of.Diagnosis))) %>%
  mutate( # NP: new breast primary
    T2NP = as.numeric(as.Date(Date.New.Breast.primary) - as.Date(Date.of.Diagnosis))) %>%
  mutate(
    T2Death = as.numeric(as.Date(Date.Death) - as.Date(Date.of.Diagnosis))) %>% 
  mutate( # LFU: last follow up
    T2LFU = as.numeric(as.Date(Date.Last.Follow.up) - as.Date(Date.of.Diagnosis)))


##################################################################
##                    Check all T2 variables                    ##
##################################################################
## Avoid writing the following codes in the future.
# range(dat3$T2Death, na.rm = TRUE)
# range(dat3$T2DR, na.rm = TRUE)
# range(dat3$T2NP, na.rm = TRUE)
# range(dat3$T2LFU, na.rm = TRUE)

var <- c("T2Death", "T2DR", "T2NP", "T2LFU")
mclapply(1:4, 
         function(i){range(dat3[var[i]], na.rm = T)},
         mc.cores = 4)
# [[1]]
# [1]  106 4235
# 
# [[2]]
# [1]   178 12714
# 
# [[3]]
# [1]  232 4848
# 
# [[4]]
# [1]     0 13573


#################################################################
##           Recode LRFS.event/DRFS.event/NPFS.event           ##
#################################################################
dat3 <- dat3 %>% 
  mutate( # LRFS: local recurrence free survival
    LRFS.event = ifelse(Local.Recurrence == "Yes", 1, 0)) %>% 
  mutate( # DRFS: distant recurrence free survival
    DRFS.event = ifelse(Distant.Recurrence == "Yes", 1, 0)) %>%
  mutate( # NPFS: new breast primary free survival
    NPFS.event = ifelse(New.Breast.Primary == "Yes", 1, 0))


##################################################################
##             Recode LRFS.time/DRFS.time/NPFS.time             ##
##################################################################
table(paste(dat3$Local.Recurrence, 
            ifelse(is.na(dat3$T2LR), "noT2LR", "T2LR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2LR:noT2D:noT2LFU 6
# NA:noT2LR:noT2D:T2LFU 75
# NA:noT2LR:T2D:T2LFU 5
# No:noT2LR:noT2D:noT2LFU 12
# Yes:noT2LR:noT2D:T2LFU 2
# 100 patients are not at risk

dat3 <- dat3 %>%
  mutate(
    LRFS.time = case_when(
      Local.Recurrence == "No" & !is.na(T2Death) & T2Death <= T2LFU ~ T2Death, # No:noT2LR:T2D:T2LFU
      Local.Recurrence == "No" & !is.na(T2Death) & T2Death > T2LFU ~ T2LFU, # No:noT2LR:T2D:T2LFU
      Local.Recurrence == "No" & is.na(T2Death) ~ T2LFU, # No:noT2LR:noT2D:noT2LFU; No:noT2LR:noT2D:T2LFU
      Local.Recurrence == "Yes" | is.na(Local.Recurrence) ~ T2LR)) # Yes:noT2LR:noT2D:T2LFU; Yes:T2LR:noT2D:T2LFU; Yes:T2LR:T2D:T2LFU; NA:noT2LR:noT2D:noT2LFU; NA:noT2LR:noT2D:T2LFU; NA:noT2LR:T2D:T2LFU

# Check the number of patients not at risk
summary(dat3$LRFS.time)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   #  0.0   557.2  1320.5  1739.5  2524.2 12694.0     100 
# 100 patients are not at risk


table(paste(dat3$Distant.Recurrence, 
            ifelse(is.na(dat3$T2DR), "noT2DR", "T2DR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2DR:noT2D:noT2LFU 6
# NA:noT2DR:noT2D:T2LFU 69
# NA:noT2DR:T2D:T2LFU 5  
# No:noT2DR:noT2D:noT2LFU 11
# Yes:noT2DR:noT2D:noT2LFU 1
# Yes:noT2DR:noT2D:T2LFU 12
# Yes:noT2DR:T2D:T2LFU 1
# 105 patients are not at risk

dat3 <- dat3 %>%
  mutate(
    DRFS.time = case_when(
      Distant.Recurrence == "No" & !is.na(T2Death) & T2Death <= T2LFU ~ T2Death, 
      Distant.Recurrence == "No" & !is.na(T2Death) & T2Death > T2LFU ~ T2LFU, 
      Distant.Recurrence == "No" & is.na(T2Death) ~ T2LFU,  
      Distant.Recurrence == "Yes" | is.na(Distant.Recurrence) ~ T2DR)) 

# Check the number of patients not at risk
summary(dat3$DRFS.time)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#    0.0   579.5  1376.0  1833.1  2701.0 12714.0     105 


table(paste(dat3$New.Breast.Primary, 
            ifelse(is.na(dat3$T2NP), "noT2NP", "T2NP"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2NP:noT2D:noT2LFU 6
# NA:noT2NP:noT2D:T2LFU 82
# NA:noT2NP:T2D:T2LFU 6  
# No:noT2NP:noT2D:noT2LFU 12
# 106 patients are not at risk

dat3 <- dat3 %>% 
  mutate(
    NPFS.time = case_when(
      New.Breast.Primary == "No" & !is.na(T2Death) & T2Death <= T2LFU ~ T2Death, 
      New.Breast.Primary == "No" & !is.na(T2Death) & T2Death > T2LFU ~ T2LFU, 
      New.Breast.Primary == "No" & is.na(T2Death) ~ T2LFU,  
      New.Breast.Primary == "Yes" | is.na(New.Breast.Primary) ~ T2NP)) 

# Check the number of patients not at risk
summary(dat3$NPFS.time)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#    0.0   609.8  1351.0  1822.8  2697.2 13573.0     106 
# 106 patients are not at risk

#################################################################
##                    Recode LR5y/DR5y/NP5y                    ##
#################################################################
# dat3$LR5y <- dat3$Local.Recurrence # Factor variable
# dat3$DR5y <- dat3$Distant.Recurrence
# dat3$NP5y <- dat3$New.Breast.Primary

dat3$LR5y = dat3$DR5y = dat3$NP5y = rep(0, times = nrow(dat3))
  
criter1 <- with(dat3, LRFS.event == 1 & !is.na(T2LR) & T2LR < 365.25*5)
table(criter1, useNA = "ifany")
# NA is not a value; R deal with NA separately
# criter1
# FALSE  TRUE 
#  549    55 
criter2 <- with(dat3, LRFS.event == 0 & !is.na(LRFS.time) & LRFS.time < 365.25*5) 
table(criter2, useNA = "ifany")
# criter2
# FALSE  TRUE 
#  344   260 
dat3$LR5y[criter1] <- 1
dat3$LR5y[criter2] <- NA
table(dat3$LR5y, useNA = "ifany")
#   0    1 <NA> 
# 289   55  260 


criter1 <- with(dat3, DRFS.event == 1 & !is.na(T2DR) & T2DR < 365.25*5)
table(criter1, useNA = "ifany")
# criter1
# FALSE  TRUE 
#  557    47 
criter2 <- with(dat3, DRFS.event == 0 & !is.na(DRFS.time) & DRFS.time < 365.25*5) 
table(criter2, useNA = "ifany")
# criter2
# FALSE  TRUE 
#  355   249 
dat3$DR5y[criter1] <- 1
dat3$DR5y[criter2] <- NA
table(dat3$DR5y, useNA = "ifany")
#   0    1 <NA> 
# 308   47  249 


criter1 <- with(dat3, NPFS.event == 1 & !is.na(T2NP) & T2NP < 365.25*5)
table(criter1, useNA = "ifany")
# criter1
# FALSE  TRUE 
#  591    13 
criter2 <- with(dat3, NPFS.event == 0 & !is.na(NPFS.time) & NPFS.time < 365.25*5) 
table(criter2, useNA = "ifany")
# criter2
# FALSE  TRUE 
#  322   282 
dat3$NP5y[criter1] <- 1
dat3$NP5y[criter2] <- NA
table(dat3$NP5y, useNA = "ifany")
#   0    1 <NA> 
# 309   13  282 

##################################################################
##                         Recode Death                         ##
##################################################################
dat3$Death <- ifelse(!is.na(dat3$Date.Death), "Yes", "No")


##################################################################
##                        Recode LRDeath                        ##
##################################################################
table(paste(dat3$Local.Recurrence, 
            ifelse(is.na(dat3$T2LR), "noT2LR", "T2LR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2LR:noT2D:noT2LFU 6
# NA:noT2LR:noT2D:T2LFU 75
# NA:noT2LR:T2D:T2LFU 5
# No:noT2LR:noT2D:noT2LFU 12
# Yes:noT2LR:noT2D:T2LFU 2
# 100 patients are not at risk

table(dat3$Local.Recurrence, dat3$Death, useNA = "ifany")
#       No Yes
# No   431  15
# Yes   63   9
# <NA>  81   5

dat3[dat3$Local.Recurrence == "Yes" & !is.na(dat3$Local.Recurrence) & dat3$Death == "Yes" & !is.na(dat3$Death), c("T2LR", "T2Death")]
#   T2LR T2Death
# 564  276     396
# 580  374     410
# 581 2373    4235
# 582 1922    3535
# 583  445     818
# 586 2498    3415
# 589  392     532
# 596 1116    1948
# 604  312     464

dat3 <- dat3 %>% 
  mutate(LRDeath = case_when(is.na(Local.Recurrence) & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             is.na(Local.Recurrence) & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             is.na(Local.Recurrence) & is.na(T2LR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Local.Recurrence == "No" & is.na(T2LR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             Local.Recurrence == "Yes" & is.na(T2LR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Local.Recurrence == "Yes" & Death == "No" ~ "LocRecur",
                             Local.Recurrence == "Yes" & Death == "Yes" ~ "LocRecur",
                             Death == "Yes" & Local.Recurrence == "No" ~ "Dead",
                             Local.Recurrence == "No" & Death == "No" ~ "Censored") %>%
  factor(levels = c("Censored", "LocRecur", "Dead")))

table(dat3$LRDeath, useNA = "ifany")
# Censored     Dead LocRecur     <NA> 
#      419       15       70      100 


##################################################################
##                        Recode DRDeath                        ##
##################################################################
table(paste(dat3$Distant.Recurrence, 
            ifelse(is.na(dat3$T2DR), "noT2DR", "T2DR"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2DR:noT2D:noT2LFU 6
# NA:noT2DR:noT2D:T2LFU 69
# NA:noT2DR:T2D:T2LFU 5  
# No:noT2DR:noT2D:noT2LFU 11
# Yes:noT2DR:noT2D:noT2LFU 1
# Yes:noT2DR:noT2D:T2LFU 12
# Yes:noT2DR:T2D:T2LFU 1
# 105 patients are not at risk

table(dat3$Distant.Recurrence, dat3$Death, useNA = "ifany")
#       No Yes
# No   441  13
# Yes   59  11
# <NA>  75   5

dat3[dat3$Distant.Recurrence == "Yes" & !is.na(dat3$Distant.Recurrence) & dat3$Death == "Yes" & !is.na(dat3$Death), c("T2DR", "T2Death")]
#     T2DR T2Death
# 237  903    1485
# 239 1120    1301
# 371  578    1091
# 520  447     550
# 564  276     396
# 581 3592    4235
# 582 3407    3535
# 583  446     818
# 586 3297    3415
# 589  392     532
# 596   NA    1948

dat3 <- dat3 %>% 
  mutate(DRDeath = case_when(is.na(Distant.Recurrence) & is.na(T2DR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             is.na(Distant.Recurrence) & is.na(T2DR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             is.na(Distant.Recurrence) & is.na(T2DR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "No" & is.na(T2DR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & is.na(T2DR) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & is.na(T2DR) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & is.na(T2DR) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             Distant.Recurrence == "Yes" & Death == "No" ~ "DisRecur",
                             Distant.Recurrence == "Yes" & Death == "Yes" ~ "DisRecur",
                             Death == "Yes" & Distant.Recurrence == "No" ~ "Dead",
                             Distant.Recurrence == "No" & Death == "No" ~ "Censored") %>%
  factor(levels = c("Censored", "DisRecur", "Dead"))
)

table(dat3$DRDeath, useNA = "ifany")
# Censored     Dead DisRecur     <NA> 
#      430       13       56      105 


##################################################################
##                        Recode NPDeath                        ##
##################################################################
table(paste(dat3$New.Breast.Primary, 
            ifelse(is.na(dat3$T2NP), "noT2NP", "T2NP"), 
            ifelse(is.na(dat3$T2Death), "noT2D", "T2D"), 
            ifelse(is.na(dat3$T2LFU), "noT2LFU", "T2LFU"), 
            sep = ":"))
# NA:noT2NP:noT2D:noT2LFU 6
# NA:noT2NP:noT2D:T2LFU 82
# NA:noT2NP:T2D:T2LFU 6  
# No:noT2NP:noT2D:noT2LFU 12
# 106 patients are not at risk

table(dat3$New.Breast.Primary, dat3$Death, useNA = "ifany")
#       No Yes
# No   471  21
# Yes   16   2
# <NA>  88   6

dat3[dat3$New.Breast.Primary == "Yes" & !is.na(dat3$New.Breast.Primary) & dat3$Death == "Yes" & !is.na(dat3$Death), c("T2NP", "T2Death")]
#     T2NP T2Death
# 564  287     396
# 582 2723    3535

dat3 <- dat3 %>% 
  mutate(NPDeath = case_when(is.na(New.Breast.Primary) & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             is.na(New.Breast.Primary) & is.na(T2NP) & is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             is.na(New.Breast.Primary) & is.na(T2NP) & !is.na(T2Death) & !is.na(T2LFU) ~ as.character(NA),
                             New.Breast.Primary == "No" & is.na(T2NP) & is.na(T2Death) & is.na(T2LFU) ~ as.character(NA),
                             New.Breast.Primary == "Yes" & Death == "No" ~ "NBP",
                             New.Breast.Primary == "Yes" & Death == "Yes" ~ "NBP",
                             Death == "Yes" & New.Breast.Primary == "No" ~ "Dead",
                             New.Breast.Primary == "No" & Death == "No" ~ "Censored") %>%
  factor(levels = c("Censored", "NBP", "Dead"))
)

table(dat3$NPDeath, useNA = "ifany")
# Censored     Dead      NBP     <NA> 
#      459       21       18      106 


##################################################################
##             Recode T2LRDeath/T2DRDeath/T2NPDeath             ##
##################################################################
dat3 <- dat3 %>% 
  mutate(T2LRDeath = case_when(LRDeath == "LocRecur" ~ T2LR,
                               LRDeath == "Dead" ~ T2Death,
                               LRDeath == "Censored" ~ T2LFU)) %>% 
  mutate(T2DRDeath = case_when(DRDeath == "DisRecur" ~ T2DR,
                               DRDeath == "Dead" ~ T2Death,
                               DRDeath == "Censored" ~ T2LFU)) %>% 
  mutate(T2NPDeath = case_when(NPDeath == "NBP" ~ T2NP,
                               NPDeath == "Dead" ~ T2Death,
                               NPDeath == "Censored" ~ T2LFU))

## Avoid writing the following codes in the future.
# sum(is.na(T2LRDeath))
# sum(is.na(T2DRDeath))
# sum(is.na(T2NPDeath))

sum.na <- function(x) {is.na(x) %>% sum()}
var <- c("T2LRDeath", "T2DRDeath", "T2NPDeath")
mclapply(1:3, 
         function(i){sum.na(dat3[var[i]])},
         mc.cores = 4)

# [[1]]
# [1] 100
# 
# [[2]]
# [1] 105
# 
# [[3]]
# [1] 106


#################################################################
##                      Fix column orders                      ##
#################################################################
dat3 <- dat3 %>%
  select("Age.at.Diagnosis", 
         "Race.Ethnicity2", 
         "Race.Ethnicity3", 
         "Local.Recurrence", 
         "Distant.Recurrence", 
         "New.Breast.Primary", 
         "ER.LR", 
         "PR.LR", 
         "HER2.LR", 
         "ER.NP", 
         "PR.NP", 
         "HER2.NP", 
         "Clinical.T.Stage", 
         "Clinical.T.Stage2", 
         "Clinical.N.Stage", 
         "Clinical.N.Stage2", 
         "Mammo.Screen.Detected", 
         "Mammo.Occult", 
         "MRI.Screen.Detected", 
         everything())


#################################################################
##                          Save data                          ##
#################################################################
dput(dat0, "../data/derived/2022Nov23_dat0.Rdata")
dput(dat1, "../data/derived/2022Nov23_dat1.Rdata")
dput(dat2, "../data/derived/2022Nov23_dat2.Rdata")
dput(dat3, "../data/derived/2022Nov23_dat3.Rdata")
dput(dat3, "../data/derived/2022Nov23_dat_TNBC.Rdata")
write.csv(dat3, "../data/derived/2022Nov23_dat_TNBC.csv", row.names = F)
```


```{r}
##################################################################
##                  Load cleaned data in Rdata                  ##
##################################################################
dat.work <- dget("../data/derived/2022Nov23_dat_TNBC.Rdata")
```


Among patients with local recurrence 72 (11.92%, n = 604),  2 patients do not have the date of local recurrence. Among patients with distant recurrence 70 (11.59%, n = 604), 13 patients do not have the date of distant recurrence. Among patients with new breast primary recurrence 18 (2.98%, n = 604), no patient does not have the date of new breast primary recurrence.

Patients who were never disease free (n=2) were counted as N/A's in terms of recurrence and new primary endpoints.

Race and ethnicity variable need careful re-examination of the categories. It seems that the two sheets contained race data based on different ways of categorization. Regarding Hisp/Latina category, it is unclear if some of the whites would have been in the Hisp/Latina category. In the current analysis, the patient with race=Arabic/Mideastern (n=1) was included in WA category.

Local recurrence free survival, distant recurrence free survival, and new primary free survival were calculated from date of diagnosis to date of event of interest and censored at date of death or date of last follow up which ever is earlier for patients not experiencing the event of interest. Local recurrence, distant recurrence, and new primary at 5 years were evaluated among patients developed the event of interest within 5 years of disease diagnosis and patients were at risk at 5 years. 

```{r, eval=FALSE, include=FALSE}
#################################################################
##       Estimate the missing distribution of recurrence       ##
#################################################################
mis.cal <- function(var1, var2) {
  siz.rec <- length(which(dat.work[var1] == "Yes"))
  mis.date.rec <- length(which(dat.work[var1] == "Yes" & is.na(dat.work[var2])))
  return(list = c(siz.rec, mis.date.rec))
}
mis.cal(var1 = "Local.Recurrence", var2 = "Date.Local.Recurrence")
mis.cal(var1 = "Distant.Recurrence", var2 = "Date.First.Distant.Recurrence")
mis.cal(var1 = "New.Breast.Primary", var2 = "Date.New.Breast.primary")
```

```{r, results="hide"}
#################################################################
##                     Set study variables                     ##
#################################################################
vars.all <- c(
  "Race.Ethnicity2",
  "Race.Ethnicity3",
  "Age.at.Diagnosis",
  "Local.Recurrence",
  "Distant.Recurrence",
  "New.Breast.Primary",
  "ER.LR",
  "PR.LR",
  "HER2.LR",
  "ER.NP",
  "PR.NP",
  "HER2.NP",
  "Clinical.T.Stage",
  "Clinical.T.Stage2",
  "Clinical.N.Stage",
  "Clinical.N.Stage2",
  "Mammo.Screen.Detected",
  "Mammo.Occult",
  "MRI.Screen.Detected",
  "Index.Tumor.Status",
  "Past.Ipsilateral.Br.CA",
  "Past.Contralateral.Br.CA",
  # "Tumor.Size.best.estimate.By.Path.Primary.surg.case",
  # "Tumor.Size.best.estimate.By.Breast.Imaging.NACT.case",
  "Needle.biopsy.proven.nodal.metastases.at.Dx",
  "Histology",
  "Any.high.grade.Disease",
  "Any.LVI",
  "Ki67",
  #"ER.expression2",
  #"PR.expression2",
  #"HER2.neu.IHC",
  #"HER2.neu.FISH",
  "First.Treatment.Modality",
  "Any.Attempt.at.Lumpectomy",
  "Mastectomy.Surgery",
  "CPM",
  "Any.SLN.Biopsy",
  "ALND" ,
  "If.Primary.Surgery.pT.Stage",
  "If.Primary.Surgery.pN.Stage",
  "Neoadjuvant.Chemotherapy",
  "In.NACT.did.pt.complete.all.planned.preop.CTX",
  "If.NACT.CTX.components.check.all.delivered.choice.A",
  "If.NACT.CTX.components.check.all.delivered.choice.T",
  "If.NACT.CTX.components.check.all.delivered.choice.C",
  "If.NACT.preop.Herceptin",
  "If.NACT.preop.Perjeta",
  "If.NACT.ypT.Stage",
  "If.NACT.ypN.Stage",
  "if.NACT.pCR",
  "If.NACT.postop.Capecitabine",
  "If.NACT.postop.Kadcyla.TDM.1",
  "Postop.Adjuvant.CTX",
  "If.Postop.Adjuvant.CTX.did.pt.complete.all.planned.postop.CTX",
  "Postop.Adjuvant.XRT",
  "Genetic.Testing.Done",
  "Genetic.Testing.Result.s",
  "Status.Last.Follow.up",
  "T2LR",
  "T2DR", 
  "T2NP",
  "T2Death",
  "T2LFU",
  "LRFS.event",
  "LRFS.time",
  "DRFS.event",
  "DRFS.time", 
  "NPFS.event",
  "NPFS.time",
  "NP5y",
  "DR5y",
  "LR5y"
)

# Create an indicator [0, 1] for all categorical variables 
vars.cat <- rep(1, length(vars.all))
vars.cat[vars.all %in% c("Age.at.Diagnosis", "T2LR", "T2DR", "T2NP", "T2Death", 
                         "T2LFU", "LRFS.time", "DRFS.time", "NPFS.time")] <- 0

# Create an index for the particular categorical variable to drop
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity2"))
```

## Methodology of summary tables

The association between a categorical variable and a grouping variable (i.e., Race.Ethnicity) was examined using the Fisher’s exact test. Difference in the value of a continuous variable among patients of different groups was examined using the Wilcoxon rank sum test (p-value is aligned with the median (IQR) summmaries in the following table). For variable with missing values, the difference in the proportion of missingness across different groups was also examined.

## Summary of patients characteristics by Race.Ethnicity2

```{r, results="hide"}
# Create an index for the particular categorical variable to drop
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity2"))

# Create a summary table by Race.Ethnicity2
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm])
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Race/Ethnicity (exclude Race.Ethnicity2 = Other)
```{r, results="hide"}
# Exclude observations with the other race/ethnicity
dat.work2 <- dat.work[dat.work$Race.Ethnicity2 != "Other", ]

# Create a summary table by Race.Ethnicity2
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity2", 
                                     "Race.Ethnicity3", 
                                     "Ki67", 
                                     "Genetic.Testing.Result.s"))
out <- fsmry.dmgrph(dat = dat.work2,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```


## Summary of patients characteristics by Race.Ethnicity3 (WA vs all other races combined)

```{r, results="hide"}
# Create a summary table by Race.Ethnicity3
vars.cat.rm <- which(vars.all %in% c("Race.Ethnicity3",
                                     "Ki67",
                                     "Genetic.Testing.Result.s"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Local.Recurrence
Note that the p-values in the following table should not be used for assessing association between each of the variables and recurrence as the analysis did not take into account different follow-up times.

```{r, results="hide"}
# Create a summary table by Local.Recurrence
vars.cat.rm <- which(vars.all %in% c("Local.Recurrence",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "ER.NP",
                                     "PR.NP",
                                     "HER2.NP"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by Distant.Recurrence
Note that the p-values in the following table should not be used for assessing association between each of the variables and recurrence as the analysis did not take into account different follow-up times.

```{r, results="hide"}
# Create a summary table by Distant.Recurrence
# table(dat.work$Distant.Recurrence, useNA = "ifany")
vars.cat.rm <- which(vars.all %in% c("Distant.Recurrence",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "ER.LR",
                                     "PR.LR",
                                     "HER2.LR",
                                     "ER.NP",
                                     "PR.NP",
                                     "HER2.NP"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by New.Breast.Primary
Note that the p-values in the following table should not be used for assessing association between each of the variables and recurrence as the analysis did not take into account different follow-up times.

```{r, results="hide"}
# Create a summary table by New.Breast.Primary
vars.cat.rm <- which(vars.all %in% c("New.Breast.Primary",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "ER.LR",
                                     "PR.LR",
                                     "HER2.LR"))
out <- fsmry.dmgrph(dat = dat.work,
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

## Summary of patients characteristics by 5-year local recurrence
```{r, results="hide"}
# Create a summary table by 5-year local recurrence
id.keep <- which(!is.na(dat.work$LR5y))
vars.cat.rm <- which(vars.all %in% c("LR5y", 
                                     "Local.Recurrence", 
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "If.NACT.preop.Perjeta", 
                                     "If.NACT.postop.Kadcyla.TDM.1",
                                     "ER.NP",
                                     "PR.NP",
                                     "HER2.NP"))

out <- fsmry.dmgrph(dat = dat.work[id.keep, ],
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])

##################################################################
##                  Problem: only one category                  ##
##################################################################
# Error in fisher.test(y.by.grp, simulate.p.value = T) : 
#   'x' must have at least 2 rows and columns
# Called from: fisher.test(y.by.grp, simulate.p.value = T)
# Browse[1]> 
# table(dat.work[id.keep, ]$If.NACT.preop.Perjeta, useNA = "ifany")
# 
#   No <NA> 
#   22  181 
```

```{r, results="asis"}
knitr::kable(out[[1]], row.names = F)
```

### Additional results for each categorical variable
```{r, results="asis"}
#################################################################
##                   Set possible predictors                   ##
#################################################################
vars.ana.rm <- c("Age.at.Diagnosis", 
                 "Local.Recurrence", 
                 "Distant.Recurrence",
                 "New.Breast.Primary",
                 "Ki67",
                 "If.NACT.postop.Kadcyla.TDM.1", # Only one category
                 "Genetic.Testing.Done",
                 "Genetic.Testing.Result.s",
                 "Status.Last.Follow.up",
                 "ER.NP",
                 "PR.NP",
                 "HER2.NP",
                 "T2LR",
                 "T2DR",
                 "T2NP",
                 "T2Death",
                 "T2LFU",
                 "LRFS.event",
                 "LRFS.time",
                 "DRFS.event",
                 "DRFS.time",
                 "NPFS.event",
                 "NPFS.time",
                 "NP5y",
                 "DR5y",
                 "LR5y")
vars.ana <- vars.all[vars.all %in% vars.ana.rm == FALSE]

id.keep <- which(!is.na(dat.work$LR5y))
for (i in 1:length(vars.ana)) {
  
  out.i <-
    fsmry2.by.grp(y = dat.work$LR5y[id.keep],
                  grp = dat.work[id.keep, vars.ana[i]],
                  cmp.method = "fisher")
  
  cat(paste0("\n#### 5-year Local Recurrence ~ ", vars.ana[[i]], "\n"))
  
  if (class(out.i) == "list") {
    
    cat(paste0("\nSummary", "\n"))
    
    print(knitr::kable(out.i[[1]]))
    
    cat(paste0("\nMissingness", "\n"))
    
    print(knitr::kable(out.i[[2]]))
  } else
    
    print(knitr::kable(out.i))
  
  cat("\n")
}
```

## Summary of patients characteristics by 5-year distant recurrence
```{r, results="hide"}
# Create a summary table by 5-year distant recurrence
id.keep <- which(!is.na(dat.work$DR5y))
vars.cat.rm <- which(vars.all %in% c("DR5y", 
                                     "Distant.Recurrence",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "If.NACT.postop.Kadcyla.TDM.1",
                                     "ER.LR",
                                     "PR.LR",
                                     "HER2.LR",
                                     "ER.NP",
                                     "PR.NP",
                                     "HER2.NP"))

out <- fsmry.dmgrph(dat = dat.work[id.keep, ],
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

### Additional results for each categorical variable
```{r, results="asis"}
vars.ana.rm <- c("Age.at.Diagnosis", 
                 "Local.Recurrence", 
                 "Distant.Recurrence",
                 "New.Breast.Primary",
                 "Ki67",
                 "If.NACT.postop.Kadcyla.TDM.1", # Only one category
                 "Genetic.Testing.Done",
                 "Genetic.Testing.Result.s",
                 "Status.Last.Follow.up",
                 "ER.LR",
                 "PR.LR",
                 "HER2.LR",
                 "ER.NP",
                 "PR.NP",
                 "HER2.NP",
                 "T2LR",
                 "T2DR",
                 "T2NP",
                 "T2Death",
                 "T2LFU",
                 "LRFS.event",
                 "LRFS.time",
                 "DRFS.event",
                 "DRFS.time",
                 "NPFS.event",
                 "NPFS.time",
                 "NP5y",
                 "DR5y",
                 "LR5y")
vars.ana <- vars.all[vars.all %in% vars.ana.rm == FALSE]

id.keep <- which(!is.na(dat.work$DR5y))
for (i in 1:length(vars.ana)) {
  
  out.i <-
    fsmry2.by.grp(y = dat.work$DR5y[id.keep],
                  grp = dat.work[id.keep, vars.ana[i]],
                  cmp.method = "fisher")
  
  cat(paste0("\n#### 5-year Distant Recurrence ~ ", vars.ana[[i]], "\n"))
  
  if (class(out.i) == "list") {
    
    cat(paste0("\nSummary", "\n"))
    
    print(knitr::kable(out.i[[1]]))
    
    cat(paste0("\nMissingness", "\n"))
    
    print(knitr::kable(out.i[[2]]))
  } else
    
    print(knitr::kable(out.i))
  
  cat("\n")
}
```

## Summary of patients characteristics by 5-year new breast primary recurrence
```{r, results="hide"}
# Create a summary table by 5-year new breast primary recurrence.
id.keep <- which(!is.na(dat.work$NP5y))
vars.cat.rm <- which(vars.all %in% c("NP5y", 
                                     "New.Breast.Primary",
                                     "Ki67", 
                                     "Genetic.Testing.Result.s",
                                     "If.NACT.postop.Kadcyla.TDM.1"))

out <- fsmry.dmgrph(dat = dat.work[id.keep, ],
                    vars = vars.all[-vars.cat.rm],
                    vars.cat = vars.cat[-vars.cat.rm],
                    by = vars.all[vars.cat.rm][1])
```

### Additional results for each categorical variable
```{r, results="asis"}
vars.ana.rm <- c("Age.at.Diagnosis", 
                 "Local.Recurrence", 
                 "Distant.Recurrence",
                 "New.Breast.Primary",
                 "Ki67",
                 "If.NACT.postop.Kadcyla.TDM.1", # Only one category
                 "Genetic.Testing.Done",
                 "Genetic.Testing.Result.s",
                 "Status.Last.Follow.up",
                 "ER.LR",
                 "PR.LR",
                 "HER2.LR",
                 "T2LR",
                 "T2DR",
                 "T2NP",
                 "T2Death",
                 "T2LFU",
                 "LRFS.event",
                 "LRFS.time",
                 "DRFS.event",
                 "DRFS.time",
                 "NPFS.event",
                 "NPFS.time",
                 "NP5y",
                 "DR5y",
                 "LR5y")
vars.ana <- vars.all[vars.all %in% vars.ana.rm == FALSE]

id.keep <- which(!is.na(dat.work$NP5y))
for (i in 1:length(vars.ana)) {
  
  out.i <-
    fsmry2.by.grp(y = dat.work$NP5y[id.keep],
                  grp = dat.work[id.keep, vars.ana[i]],
                  cmp.method = "fisher")
  
  cat(paste0("\n#### 5-year New breast Primary Recurrence ~ ", vars.ana[[i]], "\n"))
  
  if (class(out.i) == "list") {
    
    cat(paste0("\nSummary", "\n"))
    
    print(knitr::kable(out.i[[1]]))
    
    cat(paste0("\nMissingness", "\n"))
    
    print(knitr::kable(out.i[[2]]))
  } else
    
    print(knitr::kable(out.i))
  
  cat("\n")
}
```

## Incidence rate of recurrence
```{r results='hide'}
#################################################################
##              Set up variables for the for loop              ##
#################################################################
var.time <- c("T2LRDeath", "T2DRDeath", "T2NPDeath")
var.event <- c("LRDeath", "DRDeath", "NPDeath")
covar.LR <- c("ER.LR", "PR.LR", "HER2.LR")
covar.NP <- c("ER.NP", "PR.NP", "HER2.NP")

# Check the distributions of each survival time (T2LRDeath, T2DRDeath,  T2NPDeath)
# mclapply(1:3, 
#          function(i){summary(dat.work[var.time[i]])},
#          mc.cores = 4)


#################################################################
##  Run a for loop to estimate the incidence rate of LR/DR/NP  ##
#################################################################
# Note: use the min, 25%, 50%, 75%, and max of the survival time to obtain risk estimates at these time points
out.i <- vector("list", length = 3)
for (i in 1:3) {
  out.i[[i]] <-
    tidycmprsk::cuminc(formula(paste0("Surv(", var.time[i], ", ", var.event[i], ") ~ 1")), data = dat.work, conf.level = 0.95) %>%
  tidy(time = c(min(dat.work[var.time[i]], na.rm = T), 
                quantile(dat.work[var.time[i]], probs = 0.25, na.rm = T) %>% round(),
                quantile(dat.work[var.time[i]], probs = 0.50, na.rm = T) %>% round(), 
                quantile(dat.work[var.time[i]], probs = 0.75, na.rm = T) %>% round(), 
                max(dat.work[var.time[i]], na.rm = T)))
}


############################################################################
##  Run a for loop to estimate the incidence rate of LR/NP by ER/PR/HER2  ##
############################################################################
out.i.LR <- vector("list", length = 3)
for (i in 1:3) {
  out.i.LR[[i]] <-
    tidycmprsk::cuminc(formula(paste0("Surv(", var.time[1], ", ", var.event[1], ") ~ ", covar.LR[i])), data = dat.work, conf.level = 0.95) %>%
  tidy(time = c(min(dat.work[var.time[1]], na.rm = T), 
                quantile(dat.work[var.time[1]], probs = 0.25, na.rm = T) %>% round(),
                quantile(dat.work[var.time[1]], probs = 0.50, na.rm = T) %>% round(), 
                quantile(dat.work[var.time[1]], probs = 0.75, na.rm = T) %>% round(), 
                max(dat.work[var.time[1]], na.rm = T)))
}

out.i.NP <- vector("list", length = 3)
for (i in 1:3) {
  out.i.NP[[i]] <-
    tidycmprsk::cuminc(formula(paste0("Surv(", var.time[3], ", ", var.event[3], ") ~ ", covar.NP[i])), data = dat.work, conf.level = 0.95) %>%
  tidy(time = c(min(dat.work[var.time[3]], na.rm = T), 
                quantile(dat.work[var.time[3]], probs = 0.25, na.rm = T) %>% round(),
                quantile(dat.work[var.time[3]], probs = 0.50, na.rm = T) %>% round(), 
                quantile(dat.work[var.time[3]], probs = 0.75, na.rm = T) %>% round(), 
                max(dat.work[var.time[3]], na.rm = T)))
}


##################################################################
##          Run a for loop to plot the CIF of LR/DR/NP          ##
##################################################################
out.i.plot <- vector("list", length = 3)
for (i in 1:3) {
out.i.plot[[i]] <- cmprsk::cuminc(
  ftime = dat.work[var.time[i]] %>% pull(), 
  fstatus = dat.work[var.event[i]] %>% pull(),
  cencode = "Censored")
}


#################################################################
##    Run a for loop to plot the CIF of LR/NP by ER/PR/HER2    ##
#################################################################
out.i.plot.LR <- vector("list", length = 3)
for (i in 1:3) {
out.i.plot.LR[[i]] <- cmprsk::cuminc(
  ftime = dat.work[var.time[1]] %>% pull(), 
  fstatus = dat.work[var.event[1]] %>% pull(),
  cencode = "Censored",
  group = dat.work[covar.LR[i]] %>% pull())
}

out.i.plot.NP <- vector("list", length = 3)
for (i in 1:3) {
out.i.plot.NP[[i]] <- cmprsk::cuminc(
  ftime = dat.work[var.time[3]] %>% pull(), 
  fstatus = dat.work[var.event[3]] %>% pull(),
  cencode = "Censored",
  group = dat.work[covar.NP[i]] %>% pull())
}
```

### Local recurrence
```{r}
knitr::kable(out.i[[1]])
cat("\n")
plot(out.i.plot[[1]], 
     color = 1:2, 
     xlab = "Days", 
     main = "Cumulative incidence curve of LR")
```

### Local recurrence by ER
```{r}
knitr::kable(out.i.LR[[1]])
plot(out.i.plot.LR[[1]], 
     color = 1:4, 
     xlab = "Days", 
     main = "Cumulative incidence curve of LR by ER",
     cex.main = 0.8)
```

### Local recurrence by PR
```{r}
knitr::kable(out.i.LR[[2]])
plot(out.i.plot.LR[[2]], 
     color = 1:4, 
     xlab = "Days",
     main = "Cumulative incidence curve of LR by PR",
     cex.main = 0.8)
```

### Local recurrence by HER2
```{r}
knitr::kable(out.i.LR[[3]])
plot(out.i.plot.LR[[3]], 
     color = 1:4, 
     xlab = "Days",
     main = "Cumulative incidence curve of LR by HER2",
     cex.main = 0.8)
```

### Distant recurrence
```{r}
knitr::kable(out.i[[2]])
cat("\n")
plot(out.i.plot[[2]], 
     color = 1:2, 
     xlab = "Days",
     main = "Cumulative incidence curve of DR")
```

### New breast primary
```{r}
knitr::kable(out.i[[3]])
cat("\n")
plot(out.i.plot[[3]], 
     color = 1:2, 
     xlab = "Days",
     main = "Cumulative incidence curve of NP")
```

### New breast primary by ER
```{r}
knitr::kable(out.i.NP[[1]])
plot(out.i.plot.NP[[1]], 
     color = 1:4, 
     xlab = "Days",
     main = "Cumulative incidence curve of NP by ER",
     cex.main = 0.8)
```

### New breast primary by PR
```{r}
knitr::kable(out.i.NP[[2]])
plot(out.i.plot.NP[[2]], 
     color = 1:4, 
     xlab = "Days",
     main = "Cumulative incidence curve of NP by PR",
     cex.main = 0.8)
```

### New breast primary by HER2
```{r}
knitr::kable(out.i.NP[[3]])
plot(out.i.plot.NP[[3]], 
     color = 1:4, 
     xlab = "Days",
     main = "Cumulative incidence curve of NP by HER2",
     cex.main = 0.8)
```

## Session info
```{r}
sessionInfo()
```


